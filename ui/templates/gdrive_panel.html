<!-- Google Drive Sync Panel -->
<div class="gdrive-panel glass-panel">
    <div class="panel-header">
        <h3 class="panel-title">
            <svg class="icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Google Drive Sync
        </h3>
        <div class="gdrive-status" id="gdriveStatus">
            <span class="status-indicator" data-status="checking"></span>
            <span class="status-text">Checking...</span>
        </div>
    </div>
    
    <div class="panel-body">
        <!-- Configuration Section -->
        <div class="gdrive-config" id="gdriveConfig" style="display: none;">
            <p class="info-text">Google Drive is not configured. Set it up to enable cloud sync.</p>
            <button class="btn btn-secondary" onclick="installRclone()">
                <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Install rclone
            </button>
            <button class="btn btn-secondary" onclick="showConfigureDialog()">
                <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m4.22-13.22l4.24 4.24M1.54 1.54l4.24 4.24M18.36 18.36l4.24 4.24M1.54 18.36l4.24-4.24"/>
                </svg>
                Configure
            </button>
        </div>
        
        <!-- Sync Controls -->
        <div class="gdrive-controls" id="gdriveControls" style="display: none;">
            <div class="sync-info">
                <div class="info-item">
                    <span class="info-label">Mount Point:</span>
                    <span class="info-value" id="mountPoint">/workspace/gdrive</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Storage Used:</span>
                    <span class="info-value" id="storageUsed">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Sync:</span>
                    <span class="info-value" id="lastSync">Never</span>
                </div>
            </div>
            
            <div class="sync-actions">
                <h4 class="section-title">Quick Actions</h4>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="syncToGDrive()" id="syncToBtn">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload to Drive
                    </button>
                    
                    <button class="btn btn-secondary" onclick="syncFromGDrive()" id="syncFromBtn">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download from Drive
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="mountGDrive()" id="mountBtn">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/>
                            <path d="M9 22V12h6v10M2 10.6L12 2l10 8.6"/>
                        </svg>
                        Mount Drive
                    </button>
                    
                    <button class="btn btn-secondary" onclick="createSymlink()" id="symlinkBtn">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        Create Symlink
                    </button>
                </div>
            </div>
            
            <div class="auto-sync-section">
                <h4 class="section-title">Auto Sync</h4>
                <div class="auto-sync-controls">
                    <label class="toggle-label">
                        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Enable Auto Sync</span>
                    </label>
                    <div class="interval-control" id="intervalControl" style="display: none;">
                        <label for="syncInterval">Interval (minutes):</label>
                        <input type="number" id="syncInterval" min="5" max="120" value="30" class="input-field">
                        <button class="btn btn-small" onclick="updateSyncInterval()">Update</button>
                    </div>
                </div>
            </div>
            
            <div class="sync-status-section" id="syncStatusSection" style="display: none;">
                <h4 class="section-title">Sync Progress</h4>
                <div class="sync-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Idle</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.gdrive-panel {
    margin-top: 20px;
    padding: 20px;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--glass-border);
}

.panel-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
}

.gdrive-status {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-tertiary);
    position: relative;
}

.status-indicator[data-status="configured"] {
    background: #10b981;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

.status-indicator[data-status="not-configured"] {
    background: #ef4444;
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

.status-indicator[data-status="syncing"] {
    background: #f59e0b;
    animation: pulse 1.5s ease-in-out infinite;
}

.sync-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.info-label {
    font-size: 0.85rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 1rem;
    color: var(--text-primary);
    font-weight: 500;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-primary);
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), #ff5722);
    border: none;
}

.btn-primary:hover {
    box-shadow: 0 5px 20px rgba(231, 51, 29, 0.4);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.05);
}

.btn-icon {
    width: 16px;
    height: 16px;
}

.auto-sync-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.toggle-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.toggle-slider {
    width: 50px;
    height: 25px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 25px;
    position: relative;
    transition: all 0.3s ease;
}

.toggle-slider::after {
    content: '';
    position: absolute;
    width: 19px;
    height: 19px;
    background: var(--text-secondary);
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: all 0.3s ease;
}

input[type="checkbox"]:checked + .toggle-slider {
    background: var(--primary);
    border-color: var(--primary);
}

input[type="checkbox"]:checked + .toggle-slider::after {
    transform: translateX(25px);
    background: white;
}

input[type="checkbox"] {
    display: none;
}

.interval-control {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
}

.input-field {
    width: 80px;
    padding: 5px 10px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 5px;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.btn-small {
    padding: 5px 15px;
    font-size: 0.85rem;
}

.sync-progress {
    padding: 15px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #ff5722);
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
}

@media (max-width: 768px) {
    .action-buttons {
        grid-template-columns: 1fr;
    }
    
    .sync-info {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Google Drive sync functions
let syncCheckInterval;

async function checkGDriveStatus() {
    try {
        const response = await fetch('/api/gdrive/status');
        const data = await response.json();
        updateGDriveUI(data);
    } catch (error) {
        console.error('Error checking Google Drive status:', error);
    }
}

function updateGDriveUI(data) {
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');
    const configSection = document.getElementById('gdriveConfig');
    const controlsSection = document.getElementById('gdriveControls');
    
    if (data.configured) {
        statusIndicator.dataset.status = 'configured';
        statusText.textContent = 'Configured';
        configSection.style.display = 'none';
        controlsSection.style.display = 'block';
        
        // Update storage stats if available
        getStorageStats();
    } else {
        statusIndicator.dataset.status = 'not-configured';
        statusText.textContent = 'Not Configured';
        configSection.style.display = 'block';
        controlsSection.style.display = 'none';
    }
    
    // Update sync status if syncing
    if (data.sync_status && Object.keys(data.sync_status).length > 0) {
        updateSyncStatus(data.sync_status);
    }
}

async function installRclone() {
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Installing...';
        
        const response = await fetch('/api/gdrive/install_rclone', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('rclone installed successfully', 'success');
            checkGDriveStatus();
        } else {
            showNotification('Failed to install rclone', 'error');
        }
    } catch (error) {
        showNotification('Error installing rclone', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Install rclone';
    }
}

async function syncToGDrive() {
    const currentUser = getCurrentUser();
    if (!currentUser) {
        showNotification('Please select a user first', 'warning');
        return;
    }
    
    try {
        const btn = document.getElementById('syncToBtn');
        btn.disabled = true;
        btn.textContent = 'Syncing...';
        
        const response = await fetch('/api/gdrive/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: currentUser,
                direction: 'to_gdrive'
            })
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Upload started', 'success');
            startSyncMonitoring();
        } else {
            showNotification(data.message || 'Sync failed', 'error');
        }
    } catch (error) {
        showNotification('Error starting sync', 'error');
    } finally {
        setTimeout(() => {
            const btn = document.getElementById('syncToBtn');
            btn.disabled = false;
            btn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload to Drive';
        }, 2000);
    }
}

async function syncFromGDrive() {
    const currentUser = getCurrentUser();
    if (!currentUser) {
        showNotification('Please select a user first', 'warning');
        return;
    }
    
    try {
        const btn = document.getElementById('syncFromBtn');
        btn.disabled = true;
        btn.textContent = 'Syncing...';
        
        const response = await fetch('/api/gdrive/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: currentUser,
                direction: 'from_gdrive'
            })
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Download started', 'success');
            startSyncMonitoring();
        } else {
            showNotification(data.message || 'Sync failed', 'error');
        }
    } catch (error) {
        showNotification('Error starting sync', 'error');
    } finally {
        setTimeout(() => {
            const btn = document.getElementById('syncFromBtn');
            btn.disabled = false;
            btn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Download from Drive';
        }, 2000);
    }
}

async function mountGDrive() {
    try {
        const btn = document.getElementById('mountBtn');
        btn.disabled = true;
        btn.textContent = 'Mounting...';
        
        const response = await fetch('/api/gdrive/mount', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Google Drive mounted', 'success');
            document.getElementById('mountPoint').textContent = '/workspace/gdrive';
        } else {
            showNotification(data.message || 'Mount failed', 'error');
        }
    } catch (error) {
        showNotification('Error mounting drive', 'error');
    } finally {
        const btn = document.getElementById('mountBtn');
        btn.disabled = false;
        btn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="M9 22V12h6v10M2 10.6L12 2l10 8.6"/></svg>Mount Drive';
    }
}

async function createSymlink() {
    const currentUser = getCurrentUser();
    if (!currentUser) {
        showNotification('Please select a user first', 'warning');
        return;
    }
    
    try {
        const btn = document.getElementById('symlinkBtn');
        btn.disabled = true;
        btn.textContent = 'Creating...';
        
        const response = await fetch('/api/gdrive/symlink', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: currentUser})
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Symlink created successfully', 'success');
        } else {
            showNotification(data.message || 'Failed to create symlink', 'error');
        }
    } catch (error) {
        showNotification('Error creating symlink', 'error');
    } finally {
        const btn = document.getElementById('symlinkBtn');
        btn.disabled = false;
        btn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Create Symlink';
    }
}

async function getStorageStats() {
    try {
        const response = await fetch('/api/gdrive/storage');
        const data = await response.json();
        
        if (data.success && data.stats) {
            document.getElementById('storageUsed').textContent = data.stats.human_size;
        }
    } catch (error) {
        console.error('Error getting storage stats:', error);
    }
}

function toggleAutoSync() {
    const toggle = document.getElementById('autoSyncToggle');
    const intervalControl = document.getElementById('intervalControl');
    
    if (toggle.checked) {
        intervalControl.style.display = 'flex';
        setupAutoSync();
    } else {
        intervalControl.style.display = 'none';
        // Cancel auto sync
    }
}

async function setupAutoSync() {
    const interval = document.getElementById('syncInterval').value;
    
    try {
        const response = await fetch('/api/gdrive/auto_sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({interval: parseInt(interval)})
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification(`Auto-sync enabled (every ${interval} minutes)`, 'success');
        } else {
            showNotification('Failed to enable auto-sync', 'error');
            document.getElementById('autoSyncToggle').checked = false;
        }
    } catch (error) {
        showNotification('Error setting up auto-sync', 'error');
        document.getElementById('autoSyncToggle').checked = false;
    }
}

function updateSyncInterval() {
    if (document.getElementById('autoSyncToggle').checked) {
        setupAutoSync();
    }
}

function startSyncMonitoring() {
    const statusSection = document.getElementById('syncStatusSection');
    statusSection.style.display = 'block';
    
    // Poll for sync status
    syncCheckInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/gdrive/status');
            const data = await response.json();
            
            if (data.sync_status) {
                updateSyncStatus(data.sync_status);
            }
        } catch (error) {
            console.error('Error checking sync status:', error);
        }
    }, 2000);
}

function updateSyncStatus(syncStatus) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const statusIndicator = document.querySelector('.status-indicator');
    
    // Check if any user is syncing
    let anySyncing = false;
    for (const [user, status] of Object.entries(syncStatus)) {
        if (status.status === 'syncing') {
            anySyncing = true;
            progressText.textContent = `Syncing ${user}...`;
            statusIndicator.dataset.status = 'syncing';
            // Animate progress bar
            progressFill.style.width = '50%';
            break;
        } else if (status.status === 'completed') {
            progressText.textContent = `Completed sync for ${user}`;
            progressFill.style.width = '100%';
            document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
        } else if (status.status === 'error') {
            progressText.textContent = `Error: ${status.error}`;
            progressFill.style.width = '0%';
        }
    }
    
    if (!anySyncing) {
        statusIndicator.dataset.status = 'configured';
        clearInterval(syncCheckInterval);
        setTimeout(() => {
            document.getElementById('syncStatusSection').style.display = 'none';
        }, 3000);
    }
}

function getCurrentUser() {
    // Get current user from the main app state
    return window.currentUser || null;
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    checkGDriveStatus();
    // Check status every 30 seconds
    setInterval(checkGDriveStatus, 30000);
});

// Add animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>