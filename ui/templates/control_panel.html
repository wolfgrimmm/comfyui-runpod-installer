<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Cache-Control"
            content="no-cache, no-store, must-revalidate"
        />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <title>RunDeck</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&family=Space+Grotesk:wght@500;600;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://unpkg.com/lucide@latest"></script>

        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html,
            body {
                height: 100%;
                font-family: "Inter", sans-serif;
                background: #000;
                color: rgba(255, 255, 255, 0.9);
                overflow-x: hidden;
            }

            .app {
                width: 100%;
                max-width: 1440px;
                min-height: 100vh;
                margin: 0 auto;
                position: relative;
                background: #000;
            }

            /* Dark Veil WebGL Background with CSS fallback */
            #dark-veil-canvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 0;
                pointer-events: none;
                /* CSS fallback gradient if WebGL fails */
                background:
                    radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 70%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                    radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 40%),
                    #0a0a0a;
            }

            .bg {
                display: none; /* Not needed with canvas fallback */
            }

            /* Content wrapper */
            .content {
                position: relative;
                z-index: 1;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }

            /* ==================== HEADER ==================== */
            .header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 24px 40px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 24px;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .logo-dot {
                width: 10px;
                height: 10px;
                background: #8b5cf6;
                border-radius: 50%;
            }

            .logo-text {
                font-family: "Space Grotesk", sans-serif;
                font-size: 14px;
                font-weight: 600;
                letter-spacing: 2px;
                color: rgba(255, 255, 255, 0.9);
            }

            /* Status Pill */
            .status-pill {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 5px 10px;
                border-radius: 100px;
                font-size: 12px;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .status-pill.online {
                background: rgba(34, 197, 94, 0.125);
                color: #22c55e;
            }

            .status-pill.offline {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.6);
            }

            .status-pill.initializing {
                background: rgba(245, 158, 11, 0.125);
                color: #f59e0b;
            }

            .status-pill.error {
                background: rgba(239, 68, 68, 0.125);
                color: #ef4444;
            }

            .status-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .status-pill.online .status-dot {
                background: #22c55e;
                box-shadow: 0 0 8px #22c55e;
                animation: pulse 2s infinite;
            }

            .status-pill.offline .status-dot {
                background: rgba(255, 255, 255, 0.6);
            }

            .status-pill.initializing .status-dot {
                background: #f59e0b;
                box-shadow: 0 0 8px #f59e0b;
                animation: pulse 1s infinite;
            }

            .status-pill.error .status-dot {
                background: #ef4444;
                box-shadow: 0 0 8px #ef4444;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.7;
                    transform: scale(1.2);
                }
            }

            /* Header buttons */
            .header-right {
                display: flex;
                gap: 8px;
            }

            .icon-btn {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 10px;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .icon-btn:hover {
                background: rgba(255, 255, 255, 0.06);
                color: rgba(255, 255, 255, 0.9);
            }

            .icon-btn svg {
                width: 18px;
                height: 18px;
            }

            /* ==================== MAIN ==================== */
            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 24px;
                padding: 32px 40px;
            }

            .top-row {
                display: flex;
                gap: 24px;
                flex: 1;
            }

            @media (max-width: 1024px) {
                .top-row {
                    flex-direction: column;
                }
            }

            /* ==================== LEFT PANEL ==================== */
            .left-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 24px;
                padding: 24px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 20px;
            }

            /* Title section */
            .title-section {
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 16px;
            }

            .title-text h1 {
                font-family: "Space Grotesk", sans-serif;
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 6px;
            }

            .title-text p {
                font-size: 14px;
                color: rgba(255, 255, 255, 0.33);
            }

            /* User dropdown */
            .user-dropdown-wrapper {
                position: relative;
            }

            .user-dropdown {
                position: relative;
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 10px;
                cursor: pointer;
                min-width: 140px;
            }

            .user-dropdown:hover {
                background: rgba(255, 255, 255, 0.06);
            }

            .user-avatar {
                width: 24px;
                height: 24px;
                background: #8b5cf6;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: 600;
                color: white;
            }

            .user-avatar.offline {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.6);
            }

            .user-select {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.9);
                font-size: 13px;
                font-weight: 500;
                font-family: "Inter", sans-serif;
                cursor: pointer;
                outline: none;
                appearance: none;
                -webkit-appearance: none;
                padding-left: 44px;
                padding-right: 32px;
            }

            .user-select:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .user-select option {
                background: #1a1a1a;
                color: white;
            }

            .user-dropdown svg {
                width: 14px;
                height: 14px;
                color: rgba(255, 255, 255, 0.6);
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
            }

            /* Actions */
            .actions {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .primary-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                height: 56px;
                background: #8b5cf6;
                border: none;
                border-radius: 14px;
                font-family: "Space Grotesk", sans-serif;
                font-size: 16px;
                font-weight: 600;
                color: white;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .primary-btn:hover:not(:disabled) {
                background: #a78bfa;
                transform: translateY(-2px);
            }

            .primary-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .primary-btn.loading {
                background: rgba(139, 92, 246, 0.5);
                cursor: wait;
            }

            .primary-btn.success {
                background: #22c55e;
            }

            .primary-btn.success:hover:not(:disabled) {
                background: #16a34a;
            }

            .primary-btn svg {
                width: 20px;
                height: 20px;
            }

            .secondary-row {
                display: flex;
                gap: 12px;
            }

            .secondary-btn {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                height: 48px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 12px;
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .secondary-btn:hover:not(.disabled) {
                background: rgba(255, 255, 255, 0.06);
                color: rgba(255, 255, 255, 0.9);
            }

            .secondary-btn.disabled {
                opacity: 0.4;
                pointer-events: none;
            }

            .secondary-btn svg {
                width: 16px;
                height: 16px;
            }

            .secondary-btn.stop {
                background: rgba(239, 68, 68, 0.08);
                border-color: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

            .secondary-btn.stop:hover:not(.disabled) {
                background: rgba(239, 68, 68, 0.15);
            }

            /* Stats */
            .stats {
                display: flex;
                gap: 12px;
            }

            .stat-card {
                flex: 1;
                padding: 16px;
                background: rgba(255, 255, 255, 0.025);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 16px;
            }

            .stat-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }

            .stat-label {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.33);
            }

            .stat-header svg {
                width: 14px;
                height: 14px;
            }

            .stat-header svg.timer {
                color: #8b5cf6;
            }
            .stat-header svg.gpu {
                color: #22c55e;
            }
            .stat-header svg.inactive {
                color: rgba(255, 255, 255, 0.27);
            }

            .stat-value {
                font-family: "Space Grotesk", sans-serif;
                font-size: 24px;
                font-weight: 600;
            }

            .stat-value.inactive {
                color: rgba(255, 255, 255, 0.27);
            }

            /* GPU bar */
            .gpu-bar {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 12px;
                background: rgba(255, 255, 255, 0.015);
                border-radius: 8px;
            }

            .gpu-bar svg {
                width: 14px;
                height: 14px;
                color: rgba(255, 255, 255, 0.27);
            }

            .gpu-bar span {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.27);
            }

            /* ==================== RIGHT PANEL ==================== */
            .right-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 12px;
            }

            .links-row {
                display: flex;
                gap: 12px;
                flex: 1;
            }

            .link-card {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 10px;
                padding: 20px 16px;
                background: rgba(255, 255, 255, 0.025);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                cursor: pointer;
                text-decoration: none;
                transition: all 0.2s ease;
                min-height: 100px;
            }

            .link-card:hover {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
                transform: translateY(-2px);
            }

            .link-card svg {
                width: 18px;
                height: 18px;
            }
            .link-card span {
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.9);
            }

            .link-card.purple svg {
                color: #8b5cf6;
            }
            .link-card.green svg {
                color: #22c55e;
            }
            .link-card.amber svg {
                color: #f59e0b;
            }
            .link-card.cyan svg {
                color: #06b6d4;
            }

            /* ==================== CONSOLE ==================== */
            .console {
                height: 280px;
                display: flex;
                flex-direction: column;
                background: #0d0d0d;
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 16px;
                overflow: hidden;
            }

            .console-header {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.02);
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .console-header svg {
                width: 14px;
                height: 14px;
                color: rgba(255, 255, 255, 0.27);
            }

            .console-header span {
                font-size: 12px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.6);
            }

            .console-body {
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .log {
                font-family: "JetBrains Mono", monospace;
                font-size: 11px;
                line-height: 1.5;
                color: rgba(255, 255, 255, 0.4);
            }

            .log.success {
                color: #22c55e;
            }
            .log.info {
                color: #8b5cf6;
            }
            .log.error {
                color: #ef4444;
            }
            .log.warning {
                color: #f59e0b;
            }

            /* ==================== TOAST ==================== */
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                display: none;
                font-size: 14px;
                font-weight: 500;
                backdrop-filter: blur(10px);
                z-index: 1001;
                max-width: 320px;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .toast.success {
                background: rgba(34, 197, 94, 0.9);
                color: white;
            }

            .toast.error {
                background: rgba(239, 68, 68, 0.9);
                color: white;
            }

            .toast.info {
                background: rgba(139, 92, 246, 0.9);
                color: white;
            }

            /* ==================== MODAL ==================== */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10000;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: rgba(20, 20, 20, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 16px;
                width: 90%;
                max-width: 400px;
                animation: modalIn 0.3s ease;
            }

            @keyframes modalIn {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-header {
                padding: 20px 24px 16px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
            }

            .modal-close {
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.5);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                line-height: 1;
            }

            .modal-close:hover {
                color: rgba(255, 255, 255, 0.9);
            }

            .modal-body {
                padding: 20px 24px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.8);
            }

            .form-group input {
                width: 100%;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-family: "Inter", sans-serif;
            }

            .form-group input:focus {
                outline: none;
                border-color: #8b5cf6;
            }

            .form-hint {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.4);
                margin-top: 6px;
            }

            .modal-footer {
                padding: 16px 24px 20px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .modal-footer .btn {
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                border: none;
            }

            .modal-footer .btn-cancel {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.7);
            }

            .modal-footer .btn-cancel:hover {
                background: rgba(255, 255, 255, 0.12);
            }

            .modal-footer .btn-submit {
                background: #8b5cf6;
                color: white;
            }

            .modal-footer .btn-submit:hover:not(:disabled) {
                background: #a78bfa;
            }

            .modal-footer .btn-submit:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .header {
                    padding: 16px 20px;
                }
                .main {
                    padding: 20px;
                }
                .links-row {
                    flex-direction: column;
                }
            }
        </style>
    </head>
    <body>
        <!-- Dark Veil WebGL Background -->
        <canvas id="dark-veil-canvas"></canvas>

        <div class="app">
            <div class="bg"></div>

            <div class="content">
                <!-- Header -->
                <header class="header">
                    <div class="header-left">
                        <div class="logo">
                            <div class="logo-dot"></div>
                            <span class="logo-text">RUNDECK</span>
                        </div>
                        <div
                            class="status-pill {% if running %}online{% else %}offline{% endif %}"
                            id="statusPill"
                        >
                            <div class="status-dot"></div>
                            <span id="statusText"
                                >{% if running %}Running{% else %}Offline{%
                                endif %}</span
                            >
                        </div>
                    </div>
                    <div class="header-right">
                        <button
                            class="icon-btn"
                            onclick="showAddUserModal()"
                            title="Add User"
                        >
                            <i data-lucide="user-plus"></i>
                        </button>
                    </div>
                </header>

                <!-- Main -->
                <main class="main">
                    <div class="top-row">
                        <!-- Left Panel -->
                        <div class="left-panel">
                            <div class="title-section">
                                <div class="title-text">
                                    <h1 id="titleText">
                                        {% if running %}Running as {{
                                        current_user }}{% else %}ComfyUI
                                        Offline{% endif %}
                                    </h1>
                                    <p id="subtitleText">
                                        {% if running %}ComfyUI is ready to
                                        use{% else %}Select a user and launch
                                        ComfyUI{% endif %}
                                    </p>
                                </div>
                                <div class="user-dropdown-wrapper">
                                    <div class="user-dropdown">
                                        <div
                                            class="user-avatar {% if not current_user %}offline{% endif %}"
                                            id="userAvatar"
                                        >
                                            {% if current_user %}{{
                                            current_user[0]|upper }}{% else %}<i
                                                data-lucide="user"
                                                style="
                                                    width: 12px;
                                                    height: 12px;
                                                "
                                            ></i
                                            >{% endif %}
                                        </div>
                                        <select
                                            class="user-select"
                                            id="username"
                                            {%
                                            if
                                            running
                                            %}disabled{%
                                            endif
                                            %}
                                        >
                                            {% if not current_user %}
                                            <option value="" selected disabled>
                                                Select user
                                            </option>
                                            {% endif %} {% for user in users %}
                                            <option value="{{ user }}" {% if user == current_user %}selected{% endif %}>
                                                {{ user }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <i data-lucide="chevron-down"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="actions" id="actionsContainer">
                                {% if running %}
                                <button
                                    class="primary-btn success"
                                    id="primaryBtn"
                                    onclick="openComfyUI()"
                                >
                                    <i data-lucide="external-link"></i>
                                    <span>Open ComfyUI</span>
                                </button>
                                <div class="secondary-row">
                                    <button
                                        class="secondary-btn"
                                        id="restartBtn"
                                        onclick="restartService()"
                                    >
                                        <i data-lucide="rotate-ccw"></i>
                                        <span>Restart</span>
                                    </button>
                                    <button
                                        class="secondary-btn stop"
                                        id="stopBtn"
                                        onclick="stopComfyUI()"
                                    >
                                        <i data-lucide="square"></i>
                                        <span>Stop</span>
                                    </button>
                                </div>
                                {% else %}
                                <button
                                    class="primary-btn"
                                    id="primaryBtn"
                                    onclick="startComfyUI()"
                                    {%
                                    if
                                    not
                                    current_user
                                    %}disabled{%
                                    endif
                                    %}
                                >
                                    <i data-lucide="play"></i>
                                    <span>Launch ComfyUI</span>
                                </button>
                                <div class="secondary-row">
                                    <button
                                        class="secondary-btn disabled"
                                        id="restartBtn"
                                    >
                                        <i data-lucide="rotate-ccw"></i>
                                        <span>Restart</span>
                                    </button>
                                    <button
                                        class="secondary-btn stop disabled"
                                        id="stopBtn"
                                    >
                                        <i data-lucide="square"></i>
                                        <span>Stop</span>
                                    </button>
                                </div>
                                {% endif %}
                            </div>

                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <span class="stat-label"
                                            >Session Time</span
                                        >
                                        <i
                                            data-lucide="timer"
                                            class="{% if running %}timer{% else %}inactive{% endif %}"
                                            id="timerIcon"
                                        ></i>
                                    </div>
                                    <div
                                        class="stat-value {% if not running %}inactive{% endif %}"
                                        id="sessionTime"
                                    >
                                        {% if running %}0m{% else %}--:--{%
                                        endif %}
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <i
                                            data-lucide="cpu"
                                            class="{% if running %}gpu{% else %}inactive{% endif %}"
                                            id="gpuIcon"
                                        ></i>
                                        <span class="stat-label">GPU</span>
                                    </div>
                                    <div
                                        class="stat-value {% if not running %}inactive{% endif %}"
                                        id="gpuUsage"
                                    >
                                        {% if running %}Active{% else %}--{%
                                        endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="gpu-bar">
                                <i data-lucide="cpu"></i>
                                <span id="gpuInfo"
                                    >GPU information loading...</span
                                >
                            </div>
                        </div>

                        <!-- Right Panel -->
                        <div class="right-panel">
                            <div class="links-row">
                                <a
                                    class="link-card purple"
                                    href="https://pod-creator.skynetworkcdn.com/"
                                    target="_blank"
                                >
                                    <i data-lucide="plus"></i>
                                    <span>Pod Creator</span>
                                </a>
                                <a
                                    class="link-card green"
                                    href="https://s3-browser.skynetworkcdn.com/"
                                    target="_blank"
                                >
                                    <i data-lucide="folder"></i>
                                    <span>S3 Browser</span>
                                </a>
                            </div>
                            <div class="links-row">
                                <a
                                    class="link-card amber"
                                    href="javascript:void(0)"
                                    onclick="openJupyterLab()"
                                >
                                    <i data-lucide="notebook-text"></i>
                                    <span>JupyterLab</span>
                                </a>
                                <a
                                    class="link-card cyan"
                                    href="/models"
                                    target="_blank"
                                >
                                    <i data-lucide="boxes"></i>
                                    <span>Model Manager</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Console -->
                    <div class="console">
                        <div class="console-header">
                            <i data-lucide="terminal"></i>
                            <span>Console Output</span>
                        </div>
                        <div class="console-body" id="consoleBody">
                            <div class="log info">
                                [RunDeck] Control panel loaded
                            </div>
                            <div class="log">
                                {% if running %}[RunDeck] ComfyUI is running as
                                {{ current_user }}{% else %}[RunDeck] Waiting
                                for user to start ComfyUI...{% endif %}
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New User</h2>
                    <button class="modal-close" onclick="closeAddUserModal()">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newUsername">Username</label>
                        <input
                            type="text"
                            id="newUsername"
                            placeholder="e.g., john_doe"
                            autocomplete="off"
                        />
                        <div class="form-hint">
                            Lowercase letters, numbers, and underscores only
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        class="btn btn-cancel"
                        onclick="closeAddUserModal()"
                    >
                        Cancel
                    </button>
                    <button class="btn btn-submit" onclick="addNewUser()">
                        Add User
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Initialize Lucide icons
            lucide.createIcons();

            // State variables
            let checkInterval = null;
            let initializationStartTime = null;
            let counterInterval = null;
            let lastStartTime = null;
            let startTime = {% if running and start_time %}{{ start_time * 1000 }}{% else %}null{% endif %};
            let logEventSource = null;

            // Console logging
            function logToConsole(message, type = '') {
                const consoleBody = document.getElementById('consoleBody');
                const timestamp = new Date().toLocaleTimeString();
                const log = document.createElement('div');
                log.className = 'log ' + type;
                log.textContent = `[${timestamp}] ${message}`;
                consoleBody.appendChild(log);
                // Keep only last 200 logs in DOM
                while (consoleBody.children.length > 200) {
                    consoleBody.removeChild(consoleBody.firstChild);
                }
                consoleBody.scrollTop = consoleBody.scrollHeight;
            }

            // Determine log type from message content
            function getLogType(message) {
                const msg = message.toLowerCase();
                if (msg.includes('error') || msg.includes('failed') || msg.includes('exception')) return 'error';
                if (msg.includes('warning') || msg.includes('warn')) return 'warning';
                if (msg.includes('success') || msg.includes('ready') || msg.includes('loaded')) return 'success';
                if (msg.includes('import') || msg.includes('loading')) return 'info';
                return '';
            }

            // Start streaming ComfyUI logs
            function startLogStream() {
                if (logEventSource) {
                    logEventSource.close();
                }

                logEventSource = new EventSource('/api/logs/stream');

                logEventSource.onmessage = function(event) {
                    try {
                        const log = JSON.parse(event.data);
                        const type = getLogType(log.message);
                        const consoleBody = document.getElementById('consoleBody');
                        const logDiv = document.createElement('div');
                        logDiv.className = 'log ' + type;
                        logDiv.textContent = `[${log.time}] ${log.message}`;
                        consoleBody.appendChild(logDiv);
                        // Keep only last 200 logs in DOM
                        while (consoleBody.children.length > 200) {
                            consoleBody.removeChild(consoleBody.firstChild);
                        }
                        consoleBody.scrollTop = consoleBody.scrollHeight;
                    } catch (e) {
                        console.error('Error parsing log:', e);
                    }
                };

                logEventSource.onerror = function(e) {
                    console.log('Log stream disconnected, will retry...');
                    setTimeout(() => {
                        if (logEventSource) {
                            logEventSource.close();
                            startLogStream();
                        }
                    }, 3000);
                };
            }

            // Stop streaming logs
            function stopLogStream() {
                if (logEventSource) {
                    logEventSource.close();
                    logEventSource = null;
                }
            }

            // Toast notifications
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast ' + type;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 4000);
            }

            // URL helpers
            function getRunPodUrl(port) {
                const currentUrl = window.location.href;
                if (currentUrl.includes('proxy.runpod.net')) {
                    const matches = currentUrl.match(/https:\/\/([^-]+)-\d+\.proxy\.runpod\.net/);
                    if (matches) {
                        return `https://${matches[1]}-${port}.proxy.runpod.net/`;
                    }
                }
                return `http://${window.location.hostname}:${port}`;
            }

            // Update UI for running state
            function updateUIForRunningState(username) {
                const statusPill = document.getElementById('statusPill');
                const statusText = document.getElementById('statusText');
                const titleText = document.getElementById('titleText');
                const subtitleText = document.getElementById('subtitleText');
                const userAvatar = document.getElementById('userAvatar');
                const actionsContainer = document.getElementById('actionsContainer');
                const sessionTime = document.getElementById('sessionTime');
                const gpuUsage = document.getElementById('gpuUsage');
                const timerIcon = document.getElementById('timerIcon');
                const gpuIcon = document.getElementById('gpuIcon');
                const usernameSelect = document.getElementById('username');

                // Update status
                statusPill.className = 'status-pill online';
                statusText.textContent = 'Running';

                // Update title
                titleText.textContent = `Running as ${username}`;
                subtitleText.textContent = 'ComfyUI is ready to use';

                // Update avatar
                userAvatar.className = 'user-avatar';
                userAvatar.textContent = username[0].toUpperCase();

                // Disable user selection
                usernameSelect.disabled = true;

                // Update stats
                sessionTime.classList.remove('inactive');
                gpuUsage.classList.remove('inactive');
                gpuUsage.textContent = 'Active';
                timerIcon.classList.remove('inactive');
                timerIcon.classList.add('timer');
                gpuIcon.classList.remove('inactive');
                gpuIcon.classList.add('gpu');

                // Update actions
                actionsContainer.innerHTML = `
                    <button class="primary-btn success" id="primaryBtn" onclick="openComfyUI()">
                        <i data-lucide="external-link"></i>
                        <span>Open ComfyUI</span>
                    </button>
                    <div class="secondary-row">
                        <button class="secondary-btn" id="restartBtn" onclick="restartService()">
                            <i data-lucide="rotate-ccw"></i>
                            <span>Restart</span>
                        </button>
                        <button class="secondary-btn stop" id="stopBtn" onclick="stopComfyUI()">
                            <i data-lucide="square"></i>
                            <span>Stop</span>
                        </button>
                    </div>
                `;

                // Recreate icons
                lucide.createIcons();

                // Clear timers
                initializationStartTime = null;
                if (counterInterval) {
                    clearInterval(counterInterval);
                    counterInterval = null;
                }

                // Play success sound
                playSuccessSound();

                // Auto-open ComfyUI
                setTimeout(() => openComfyUI(), 500);
            }

            // Update UI for initializing state
            function updateUIForInitializingState(message) {
                const statusPill = document.getElementById('statusPill');
                const statusText = document.getElementById('statusText');
                const subtitleText = document.getElementById('subtitleText');

                statusPill.className = 'status-pill initializing';
                statusText.textContent = message || 'Initializing...';
                subtitleText.textContent = 'Please wait...';
            }

            // Play success sound
            function playSuccessSound() {
                try {
                    if (document.hidden) return;
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 523.25;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 659.25;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0, audioContext.currentTime);
                        gain2.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                        gain2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.15);
                        osc2.start(audioContext.currentTime);
                        osc2.stop(audioContext.currentTime + 0.15);
                    }, 100);
                } catch (e) {}
            }

            // Start ComfyUI
            async function startComfyUI() {
                const username = document.getElementById('username').value;
                if (!username) {
                    showToast('Please select a user', 'error');
                    return;
                }

                const primaryBtn = document.getElementById('primaryBtn');
                primaryBtn.disabled = true;
                primaryBtn.classList.add('loading');
                primaryBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i><span>Starting...</span>';
                lucide.createIcons();

                logToConsole(`Starting ComfyUI for user: ${username}`, 'info');

                lastStartTime = Date.now();
                initializationStartTime = Date.now();

                // Start counter interval
                counterInterval = setInterval(() => {
                    if (initializationStartTime) {
                        const elapsed = Math.floor((Date.now() - initializationStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                        updateUIForInitializingState(`Initializing (${timeStr})`);
                    }
                }, 1000);

                try {
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username})
                    });

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        logToConsole('ComfyUI process started, waiting for initialization...', 'success');
                        showToast('ComfyUI starting...', 'info');

                        // Start streaming ComfyUI logs
                        startLogStream();

                        // Start polling for ready state
                        checkInterval = setInterval(async () => {
                            try {
                                const statusResponse = await fetch('/api/status');
                                const statusData = await statusResponse.json();

                                if (statusData.running && statusData.ready) {
                                    clearInterval(checkInterval);
                                    checkInterval = null;
                                    logToConsole('ComfyUI is ready!', 'success');
                                    showToast('ComfyUI is ready!', 'success');
                                    updateUIForRunningState(username);

                                    if (statusData.start_time) {
                                        startTime = statusData.start_time * 1000;
                                        updateUptime();
                                    }
                                }
                            } catch (e) {
                                // Silently handle errors during startup
                            }
                        }, 1500);
                    } else {
                        throw new Error(data.error || 'Failed to start');
                    }
                } catch (error) {
                    logToConsole(`Error: ${error.message}`, 'error');
                    showToast(error.message, 'error');

                    if (counterInterval) {
                        clearInterval(counterInterval);
                        counterInterval = null;
                    }

                    primaryBtn.disabled = false;
                    primaryBtn.classList.remove('loading');
                    primaryBtn.innerHTML = '<i data-lucide="play"></i><span>Launch ComfyUI</span>';
                    lucide.createIcons();

                    const statusPill = document.getElementById('statusPill');
                    statusPill.className = 'status-pill error';
                    document.getElementById('statusText').textContent = 'Error';
                }
            }

            // Stop ComfyUI
            async function stopComfyUI() {
                if (!confirm('Stop ComfyUI? Unsaved work will be lost.')) return;

                const stopBtn = document.getElementById('stopBtn');
                stopBtn.classList.add('disabled');
                logToConsole('Stopping ComfyUI...', 'warning');

                try {
                    await fetch('/api/stop', { method: 'POST' });
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    showToast('ComfyUI stopped', 'success');
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    showToast('Error stopping: ' + error.message, 'error');
                    stopBtn.classList.remove('disabled');
                }
            }

            // Restart service
            async function restartService() {
                if (!confirm('Restart ComfyUI?')) return;

                logToConsole('Restarting ComfyUI...', 'warning');

                try {
                    await fetch('/api/stop', { method: 'POST' });
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    const username = document.getElementById('username').value || '{{ current_user }}';
                    await fetch('/api/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username})
                    });

                    showToast('Restarting...', 'info');
                    setTimeout(() => location.reload(), 2000);
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                }
            }

            // Open ComfyUI
            function openComfyUI() {
                const url = getRunPodUrl(8188);
                window.open(url, '_blank');
                logToConsole('Opening ComfyUI...', 'info');
            }

            // Open JupyterLab
            function openJupyterLab() {
                const url = getRunPodUrl(8888);
                window.open(url, '_blank');
                logToConsole('Opening JupyterLab...', 'info');
            }

            // Update uptime display
            function updateUptime() {
                if (startTime) {
                    const elapsed = Date.now() - startTime;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    document.getElementById('sessionTime').textContent = timeStr;
                }
            }

            // User dropdown change handler
            document.getElementById('username').addEventListener('change', function(e) {
                const primaryBtn = document.getElementById('primaryBtn');
                const userAvatar = document.getElementById('userAvatar');

                if (e.target.value) {
                    primaryBtn.disabled = false;
                    userAvatar.className = 'user-avatar';
                    userAvatar.textContent = e.target.value[0].toUpperCase();
                } else {
                    primaryBtn.disabled = true;
                }
                lucide.createIcons();
            });

            // Add user modal functions
            function showAddUserModal() {
                document.getElementById('addUserModal').style.display = 'flex';
                document.getElementById('newUsername').value = '';
                document.getElementById('newUsername').focus();
            }

            function closeAddUserModal() {
                document.getElementById('addUserModal').style.display = 'none';
            }

            async function addNewUser() {
                const username = document.getElementById('newUsername').value.trim().toLowerCase();
                const submitBtn = document.querySelector('#addUserModal .btn-submit');

                if (!username) {
                    showToast('Please enter a username', 'error');
                    return;
                }

                if (!/^[a-z0-9_]+$/.test(username)) {
                    showToast('Invalid username format', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding...';

                try {
                    const response = await fetch('/api/add_user', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: username })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('User added successfully', 'success');
                        closeAddUserModal();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(data.error || 'Failed to add user', 'error');
                    }
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add User';
                }
            }

            // Modal close handlers
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAddUserModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target.id === 'addUserModal') closeAddUserModal();
            });

            // Periodic status check
            setInterval(async () => {
                try {
                    const response = await fetch('/api/status');
                    const contentType = response.headers.get('content-type');
                    if (!response.ok || !contentType || !contentType.includes('application/json')) return;

                    const data = await response.json();
                    const statusPill = document.getElementById('statusPill');
                    const statusText = document.getElementById('statusText');

                    if (data.running && data.ready) {
                        const username = data.current_user || 'User';
                        statusPill.className = 'status-pill online';
                        statusText.textContent = 'Running';

                        if (data.start_time && !startTime) {
                            startTime = data.start_time * 1000;
                            updateUptime();
                        }
                    } else if (data.running && !data.ready) {
                        statusPill.className = 'status-pill initializing';
                        statusText.textContent = 'Initializing...';
                    } else {
                        const withinStartupWindow = lastStartTime && (Date.now() - lastStartTime < 20 * 60 * 1000);
                        if (withinStartupWindow) {
                            statusPill.className = 'status-pill initializing';
                            const elapsed = Math.floor((Date.now() - lastStartTime) / 1000);
                            const minutes = Math.floor(elapsed / 60);
                            const seconds = elapsed % 60;
                            statusText.textContent = `Initializing (${minutes > 0 ? minutes + 'm ' : ''}${seconds}s)`;
                        } else {
                            statusPill.className = 'status-pill offline';
                            statusText.textContent = 'Offline';
                        }
                    }
                } catch (e) {}
            }, 3000);

            // Update uptime every minute
            setInterval(updateUptime, 60000);
            updateUptime();

            // Load GPU info and start log stream if running
            fetch('/api/status').then(r => r.json()).then(data => {
                if (data.gpu_info) {
                    document.getElementById('gpuInfo').textContent = data.gpu_info;
                }
                // Start log stream if ComfyUI is running
                if (data.running) {
                    startLogStream();
                }
            }).catch(() => {});

            // Make functions global
            window.startComfyUI = startComfyUI;
            window.stopComfyUI = stopComfyUI;
            window.openComfyUI = openComfyUI;
            window.openJupyterLab = openJupyterLab;
            window.restartService = restartService;
            window.showAddUserModal = showAddUserModal;
            window.closeAddUserModal = closeAddUserModal;
            window.addNewUser = addNewUser;
        </script>

        <!-- Dark Veil WebGL Background -->
        <script src="/static/ogl.bundle.js"></script>
        <script>
            (function() {
                const canvas = document.getElementById('dark-veil-canvas');
                if (!canvas) return;

                let frameId = 0;

                function initWebGL() {
                    if (!window.OGL || !canvas) return;

                    const { Renderer, Program, Mesh, Triangle, Vec2 } = window.OGL;

                    const speed = 0.5;
                    const warpAmount = 0.5;
                    const resolutionScale = 0.5;

                    const vertex = `attribute vec2 position; void main(){gl_Position=vec4(position,0.0,1.0);}`;

                    const fragment = `
precision highp float;
uniform vec2 uResolution;
uniform float uTime;
uniform float uWarp;

vec4 buf[8];
float rand(vec2 c){return fract(sin(dot(c,vec2(12.9898,78.233)))*43758.5453);}

vec4 sigmoid(vec4 x){return 1./(1.+exp(-x));}

vec4 cppn_fn(vec2 coordinate,float in0,float in1,float in2){
    buf[6]=vec4(coordinate.x,coordinate.y,0.3948333106474662+in0,0.36+in1);
    buf[7]=vec4(0.14+in2,sqrt(coordinate.x*coordinate.x+coordinate.y*coordinate.y),0.,0.);
    buf[0]=mat4(vec4(6.5404263,-3.6126034,0.7590882,-1.13613),vec4(2.4582713,3.1660357,1.2219609,0.06276096),vec4(-5.478085,-6.159632,1.8701609,-4.7742867),vec4(6.039214,-5.542865,-0.90925294,3.251348))*buf[6]+mat4(vec4(0.8473259,-5.722911,3.975766,1.6522468),vec4(-0.24321538,0.5839259,-1.7661959,-5.350116),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(0.21808943,1.1243913,-1.7969975,5.0294676);
    buf[1]=mat4(vec4(-3.3522482,-6.0612736,0.55641043,-4.4719114),vec4(0.8631464,1.7432913,5.643898,1.6106541),vec4(2.4941394,-3.5012043,1.7184316,6.357333),vec4(3.310376,8.209261,1.1355612,-1.165539))*buf[6]+mat4(vec4(5.24046,-13.034365,0.009859298,15.870829),vec4(2.987511,3.129433,-0.89023495,-1.6822904),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(-5.9457836,-6.573602,-0.8812491,1.5436668);
    buf[0]=sigmoid(buf[0]);buf[1]=sigmoid(buf[1]);
    buf[2]=mat4(vec4(-15.219568,8.095543,-2.429353,-1.9381982),vec4(-5.951362,4.3115187,2.6393783,1.274315),vec4(-7.3145227,6.7297835,5.2473326,5.9411426),vec4(5.0796127,8.979051,-1.7278991,-1.158976))*buf[6]+mat4(vec4(-11.967154,-11.608155,6.1486754,11.237008),vec4(2.124141,-6.263192,-1.7050359,-0.7021966),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(-4.17164,-3.2281182,-4.576417,-3.6401186);
    buf[3]=mat4(vec4(3.1832156,-13.738922,1.879223,3.233465),vec4(0.64300746,12.768129,1.9141049,0.50990224),vec4(-0.049295485,4.4807224,1.4733979,1.801449),vec4(5.0039253,13.000481,3.3991797,-4.5561905))*buf[6]+mat4(vec4(-0.1285731,7.720628,-3.1425676,4.742367),vec4(0.6393625,3.714393,-0.8108378,-0.39174938),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(-1.1811101,-21.621881,0.7851888,1.2329718);
    buf[2]=sigmoid(buf[2]);buf[3]=sigmoid(buf[3]);
    buf[4]=mat4(vec4(5.214916,-7.183024,2.7228765,2.6592617),vec4(-5.601878,-25.3591,4.067988,0.4602802),vec4(-10.57759,24.286327,21.102104,37.546658),vec4(4.3024497,-1.9625226,2.3458803,-1.372816))*buf[0]+mat4(vec4(-17.6526,-10.507558,2.2587414,12.462782),vec4(6.265566,-502.75443,-12.642513,0.9112289),vec4(-10.983244,20.741234,-9.701768,-0.7635988),vec4(5.383626,1.4819539,-4.1911616,-4.8444734))*buf[1]+mat4(vec4(12.785233,-16.345072,-0.39901125,1.7955981),vec4(-30.48365,-1.8345358,1.4542528,-1.1118771),vec4(19.872723,-7.337935,-42.941723,-98.52709),vec4(8.337645,-2.7312303,-2.2927687,-36.142323))*buf[2]+mat4(vec4(-16.298317,3.5471997,-0.44300047,-9.444417),vec4(57.5077,-35.609753,16.163465,-4.1534753),vec4(-0.07470326,-3.8656476,-7.0901804,3.1523974),vec4(-12.559385,-7.077619,1.490437,-0.8211543))*buf[3]+vec4(-7.67914,15.927437,1.3207729,-1.6686112);
    buf[5]=mat4(vec4(-1.4109162,-0.372762,-3.770383,-21.367174),vec4(-6.2103205,-9.35908,0.92529047,8.82561),vec4(11.460242,-22.348068,13.625772,-18.693201),vec4(-0.3429052,-3.9905605,-2.4626114,-0.45033523))*buf[0]+mat4(vec4(7.3481627,-4.3661838,-6.3037653,-3.868115),vec4(1.5462853,6.5488915,1.9701879,-0.58291394),vec4(6.5858274,-2.2180402,3.7127688,-1.3730392),vec4(-5.7973905,10.134961,-2.3395722,-5.965605))*buf[1]+mat4(vec4(-2.5132585,-6.6685553,-1.4029363,-0.16285264),vec4(-0.37908727,0.53738135,4.389061,-1.3024765),vec4(-0.70647055,2.0111287,-5.1659346,-3.728635),vec4(-13.562562,10.487719,-0.9173751,-2.6487076))*buf[2]+mat4(vec4(-8.645013,6.5546675,-6.3944063,-5.5933375),vec4(-0.57783127,-1.077275,36.91025,5.736769),vec4(14.283112,3.7146652,7.1452246,-4.5958776),vec4(2.7192075,3.6021907,-4.366337,-2.3653464))*buf[3]+vec4(-5.9000807,-4.329569,1.2427121,8.59503);
    buf[4]=sigmoid(buf[4]);buf[5]=sigmoid(buf[5]);
    buf[6]=mat4(vec4(-1.61102,0.7970257,1.4675229,0.20917463),vec4(-28.793737,-7.1390953,1.5025433,4.656581),vec4(-10.94861,39.66238,0.74318546,-10.095605),vec4(-0.7229728,-1.5483948,0.7301322,2.1687684))*buf[0]+mat4(vec4(3.2547753,21.489103,-1.0194173,-3.3100595),vec4(-3.7316632,-3.3792162,-7.223193,-0.23685838),vec4(13.1804495,0.7916005,5.338587,5.687114),vec4(-4.167605,-17.798311,-6.815736,-1.6451967))*buf[1]+mat4(vec4(0.604885,-7.800309,-7.213122,-2.741014),vec4(-3.522382,-0.12359311,-0.5258442,0.43852118),vec4(9.6752825,-22.853785,2.062431,0.099892326),vec4(-4.3196306,-17.730087,2.5184598,5.30267))*buf[2]+mat4(vec4(-6.545563,-15.790176,-6.0438633,-5.415399),vec4(-43.591583,28.551912,-16.00161,18.84728),vec4(4.212382,8.394307,3.0958717,8.657522),vec4(-5.0237565,-4.450633,-4.4768,-5.5010443))*buf[3]+mat4(vec4(1.6985557,-67.05806,6.897715,1.9004834),vec4(1.8680354,2.3915145,2.5231109,4.081538),vec4(11.158006,1.7294737,2.0738268,7.386411),vec4(-4.256034,-306.24686,8.258898,-17.132736))*buf[4]+mat4(vec4(1.6889864,-4.5852966,3.8534803,-6.3482175),vec4(1.3543309,-1.2640043,9.932754,2.9079645),vec4(-5.2770967,0.07150358,-0.13962056,3.3269649),vec4(28.34703,-4.918278,6.1044083,4.085355))*buf[5]+vec4(6.6818056,12.522166,-3.7075126,-4.104386);
    buf[7]=mat4(vec4(-8.265602,-4.7027016,5.098234,0.7509808),vec4(8.6507845,-17.15949,16.51939,-8.884479),vec4(-4.036479,-2.3946867,-2.6055532,-1.9866527),vec4(-2.2167742,-1.8135649,-5.9759874,4.8846445))*buf[0]+mat4(vec4(6.7790847,3.5076547,-2.8191125,-2.7028968),vec4(-5.743024,-0.27844876,1.4958696,-5.0517144),vec4(13.122226,15.735168,-2.9397483,-4.101023),vec4(-14.375265,-5.030483,-6.2599335,2.9848232))*buf[1]+mat4(vec4(4.0950394,-0.94011575,-5.674733,4.755022),vec4(4.3809423,4.8310084,1.7425908,-3.437416),vec4(2.117492,0.16342592,-104.56341,16.949184),vec4(-5.22543,-2.994248,3.8350096,-1.9364246))*buf[2]+mat4(vec4(-5.900337,1.7946124,-13.604192,-3.8060522),vec4(6.6583457,31.911177,25.164474,91.81147),vec4(11.840538,4.1503043,-0.7314397,6.768467),vec4(-6.3967767,4.034772,6.1714606,-0.32874924))*buf[3]+mat4(vec4(3.4992442,-196.91893,-8.923708,2.8142626),vec4(3.4806502,-3.1846354,5.1725626,5.1804223),vec4(-2.4009497,15.585794,1.2863957,2.0252278),vec4(-71.25271,-62.441242,-8.138444,0.50670296))*buf[4]+mat4(vec4(-12.291733,-11.176166,-7.3474145,4.390294),vec4(10.805477,5.6337385,-0.9385842,-4.7348723),vec4(-12.869276,-7.039391,5.3029537,7.5436664),vec4(1.4593618,8.91898,3.5101583,5.840625))*buf[5]+vec4(2.2415268,-6.705987,-0.98861027,-2.117676);
    buf[6]=sigmoid(buf[6]);buf[7]=sigmoid(buf[7]);
    buf[0]=mat4(vec4(1.6794263,1.3817469,2.9625452,0.),vec4(-1.8834411,-1.4806935,-3.5924516,0.),vec4(-1.3279216,-1.0918057,-2.3124623,0.),vec4(0.2662234,0.23235129,0.44178495,0.))*buf[0]+mat4(vec4(-0.6299101,-0.5945583,-0.9125601,0.),vec4(0.17828953,0.18300213,0.18182953,0.),vec4(-2.96544,-2.5819945,-4.9001055,0.),vec4(1.4195864,1.1868085,2.5176322,0.))*buf[1]+mat4(vec4(-1.2584374,-1.0552157,-2.1688404,0.),vec4(-0.7200217,-0.52666044,-1.438251,0.),vec4(0.15345335,0.15196142,0.272854,0.),vec4(0.945728,0.8861938,1.2766753,0.))*buf[2]+mat4(vec4(-2.4218085,-1.968602,-4.35166,0.),vec4(-22.683098,-18.0544,-41.954372,0.),vec4(0.63792,0.5470648,1.1078634,0.),vec4(-1.5489894,-1.3075932,-2.6444845,0.))*buf[3]+mat4(vec4(-0.49252132,-0.39877754,-0.91366625,0.),vec4(0.95609266,0.7923952,1.640221,0.),vec4(0.30616966,0.15693925,0.8639857,0.),vec4(1.1825981,0.94504964,2.176963,0.))*buf[4]+mat4(vec4(0.35446745,0.3293795,0.59547555,0.),vec4(-0.58784515,-0.48177817,-1.0614829,0.),vec4(2.5271258,1.9991658,4.6846647,0.),vec4(0.13042648,0.08864098,0.30187556,0.))*buf[5]+mat4(vec4(-1.7718065,-1.4033192,-3.3355875,0.),vec4(3.1664357,2.638297,5.378702,0.),vec4(-3.1724713,-2.6107926,-5.549295,0.),vec4(-2.851368,-2.249092,-5.3013067,0.))*buf[6]+mat4(vec4(1.5203838,1.2212278,2.8404984,0.),vec4(1.5210563,1.2651345,2.683903,0.),vec4(2.9789467,2.4364579,5.2347264,0.),vec4(2.2270417,1.8825914,3.8028636,0.))*buf[7]+vec4(-1.5468478,-3.6171484,0.24762098,0.);
    buf[0]=sigmoid(buf[0]);
    return vec4(buf[0].x,buf[0].y,buf[0].z,1.);
}

void mainImage(out vec4 fragColor,in vec2 fragCoord){
    vec2 uv=fragCoord/uResolution.xy*2.-1.;
    uv.y*=-1.;
    uv.y-=0.5;
    uv+=uWarp*vec2(sin(uv.y*6.283+uTime*0.5),cos(uv.x*6.283+uTime*0.5))*0.05;
    fragColor=cppn_fn(uv,0.1*sin(0.3*uTime),0.1*sin(0.69*uTime),0.1*sin(0.44*uTime));
}

void main(){
    vec4 col;mainImage(col,gl_FragCoord.xy);
    gl_FragColor=vec4(clamp(col.rgb,0.0,1.0),1.0);
}
`;

                    const renderer = new Renderer({
                        dpr: Math.min(window.devicePixelRatio, 2),
                        canvas,
                    });
                    const gl = renderer.gl;
                    const geometry = new Triangle(gl);

                    const program = new Program(gl, {
                        vertex,
                        fragment,
                        uniforms: {
                            uTime: { value: 0 },
                            uResolution: { value: new Vec2() },
                            uWarp: { value: warpAmount },
                        },
                    });

                    const mesh = new Mesh(gl, { geometry, program });

                    const resize = () => {
                        const w = window.innerWidth;
                        const h = window.innerHeight;
                        renderer.setSize(w * resolutionScale, h * resolutionScale);
                        canvas.style.width = w + 'px';
                        canvas.style.height = h + 'px';
                        program.uniforms.uResolution.value.set(w, h);
                    };

                    window.addEventListener('resize', resize);
                    resize();

                    const start = performance.now();

                    const loop = () => {
                        program.uniforms.uTime.value = ((performance.now() - start) / 1000) * speed;
                        renderer.render({ scene: mesh });
                        frameId = requestAnimationFrame(loop);
                    };

                    loop();

                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            cancelAnimationFrame(frameId);
                        } else {
                            frameId = requestAnimationFrame(loop);
                        }
                    });
                }

                // Check if OGL is already loaded
                if (window.OGL) {
                    initWebGL();
                } else {
                    // Wait for OGL to load
                    const checkOGL = setInterval(() => {
                        if (window.OGL) {
                            clearInterval(checkOGL);
                            initWebGL();
                        }
                    }, 50);
                    // Timeout after 5 seconds
                    setTimeout(() => clearInterval(checkOGL), 5000);
                }
            })();
        </script>
    </body>
</html>
