<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Cache-Control"
            content="no-cache, no-store, must-revalidate"
        />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <title>ComfyUI Control Panel</title>

        <!-- Premium Animation Libraries -->
        <!-- GSAP - Industry standard animation engine -->
        <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>

        <!-- Atropos - 3D Parallax Depth Effects -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/atropos@2.0.2/atropos.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/atropos@2.0.2/atropos.min.js"></script>

        <!-- Lottie - GPU-Accelerated Animations -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

        <!-- Rive - Interactive State Machine Animations -->
        <script src="https://unpkg.com/@rive-app/canvas@2.7.0"></script>

        <!-- OGL - Minimal WebGL library for DarkVeil background -->
        <script src="https://cdn.jsdelivr.net/npm/ogl/dist/ogl.umd.js"></script>

        <!-- Lottie Player for easy integration -->
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

        <!-- Simple CSS Animations -->
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");
            @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

            :root {
                /* Light, airy glass design with purple accents */
                --primary: #8b5cf6;
                --primary-glow: rgba(139, 92, 246, 0.3);
                --accent: #a78bfa;
                --accent-secondary: #7c3aed;
                --glass-bg: rgba(255, 255, 255, 0.1);
                --glass-border: rgba(255, 255, 255, 0.18);
                --text-primary: rgba(255, 255, 255, 0.9);
                --text-secondary: rgba(255, 255, 255, 0.6);
                --text-tertiary: rgba(255, 255, 255, 0.4);
                --blur-strength: 30px;
                --animation-speed: 0.3s;
                --hover-transform: translateY(-4px);
                --shadow-color: rgba(0, 0, 0, 0.12);
                --shadow-color-light: rgba(0, 0, 0, 0.06);

                /* Apple-style border radius system */
                --radius-xl: 20px; /* Large containers, cards */
                --radius-lg: 16px; /* Medium containers */
                --radius-md: 12px; /* Buttons, inputs, controls */
                --radius-sm: 8px; /* Small elements, badges */
                --radius-xs: 6px; /* Tiny elements */
            }

            @keyframes backgroundFloat {
                0%,
                100% {
                    transform: rotate(0deg) scale(1);
                }
                33% {
                    transform: rotate(1deg) scale(1.02);
                }
                66% {
                    transform: rotate(-1deg) scale(1.01);
                }
            }

            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.05);
                    opacity: 0.8;
                }
            }

            @keyframes shimmer {
                0% {
                    background-position: -200% center;
                }
                100% {
                    background-position: 200% center;
                }
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            @keyframes scaleIn {
                from {
                    transform: scale(0.9);
                    opacity: 0;
                }
                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            /* ===== ADVANCED STUNNING ANIMATIONS ===== */
            @keyframes magneticHover {
                0% {
                    transform: translate(0, 0) scale(1);
                }
                100% {
                    transform: translate(var(--tx), var(--ty)) scale(1.02);
                }
            }

            @keyframes morphBorder {
                0%,
                100% {
                    border-radius: var(--radius-lg);
                }
                50% {
                    border-radius: var(--radius-xl);
                }
            }

            @keyframes glowPulse {
                0%,
                100% {
                    box-shadow:
                        0 0 20px rgba(107, 107, 107, 0.3),
                        0 0 40px rgba(107, 107, 107, 0.2),
                        0 0 60px rgba(107, 107, 107, 0.1);
                }
                50% {
                    box-shadow:
                        0 0 30px rgba(107, 107, 107, 0.5),
                        0 0 60px rgba(107, 107, 107, 0.3),
                        0 0 90px rgba(107, 107, 107, 0.2);
                }
            }

            @keyframes smoothSlideUp {
                from {
                    opacity: 0;
                    transform: translateY(40px) scale(0.96);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            @keyframes elasticBounce {
                0% {
                    transform: scale(0) rotate(-180deg);
                }
                60% {
                    transform: scale(1.1) rotate(10deg);
                }
                80% {
                    transform: scale(0.95) rotate(-5deg);
                }
                100% {
                    transform: scale(1) rotate(0deg);
                }
            }

            @keyframes floatSmooth {
                0%,
                100% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            @keyframes rippleEffect {
                0% {
                    transform: scale(0);
                    opacity: 0.6;
                }
                100% {
                    transform: scale(4);
                    opacity: 0;
                }
            }

            @keyframes gradientShift {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }

            @keyframes particleDrift {
                0% {
                    transform: translate(0, 0) rotate(0deg);
                }
                33% {
                    transform: translate(30px, -30px) rotate(120deg);
                }
                66% {
                    transform: translate(-20px, 20px) rotate(240deg);
                }
                100% {
                    transform: translate(0, 0) rotate(360deg);
                }
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: #000;
                color: var(--text-primary);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                position: relative;
                overflow-y: auto;
                overflow-x: hidden;
            }

            body::before {
                display: none;
            }

            /* Advanced Particle System */
            .particle-canvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
                opacity: 0.6;
            }

            /* Enhanced Glow Effects */
            .glow-effect {
                position: relative;
            }

            /* Removed glow-effect::before to eliminate any potential gray tint */

            /* ===== ADVANCED BUTTON ANIMATIONS ===== */
            .btn-advanced {
                position: relative;
                overflow: hidden;
                background: linear-gradient(
                    135deg,
                    rgba(107, 107, 107, 0.15),
                    rgba(107, 107, 107, 0.1)
                );
                background-size: 200% 200%;
                border: 1px solid rgba(255, 255, 255, 0.15);
                transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
                animation: gradientShift 4s ease infinite;
            }

            .btn-advanced::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent
                );
                transition: left 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            }

            .btn-advanced:hover::before {
                left: 100%;
            }

            .btn-advanced:hover {
                transform: translateY(-4px) scale(1.03);
                border-color: rgba(255, 255, 255, 0.3);
                box-shadow:
                    0 20px 50px rgba(107, 107, 107, 0.3),
                    0 0 80px rgba(107, 107, 107, 0.2),
                    0 0 0 1px rgba(255, 255, 255, 0.2);
            }

            .btn-advanced:active {
                transform: translateY(-2px) scale(0.98);
            }

            /* Floating Elements Animation */
            @keyframes float {
                0%,
                100% {
                    transform: translateY(0px) rotate(0deg);
                }
                33% {
                    transform: translateY(-10px) rotate(1deg);
                }
                66% {
                    transform: translateY(-5px) rotate(-1deg);
                }
            }

            .floating {
                animation: float 6s ease-in-out infinite;
            }

            /* Magnetic Hover Effect */
            .magnetic {
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .magnetic:hover {
                transform: scale(1.05);
            }

            /* Huly.io-style Gradient Fade Effect - REMOVED */
            .main-wrapper::after {
                display: none;
            }

            .container {
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(50px) saturate(150%);
                -webkit-backdrop-filter: blur(50px) saturate(150%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-top: 1px solid rgba(255, 255, 255, 0.25);
                border-radius: var(--radius-xl);
                padding: 32px;
                width: 100%;
                max-width: 440px;
                box-shadow:
                    0 25px 50px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
                position: relative;
                z-index: 1;
                animation: slideInUp 0.8s ease-out;
                overflow: hidden;
                margin: 0 auto;
                transition:
                    border-color 0.3s ease,
                    background 0.3s ease;
            }

            /* Responsive breakpoints */
            @media (max-width: 768px) {
                .container {
                    max-width: 90%;
                    padding: 40px;
                }
            }

            @media (max-width: 576px) {
                .container {
                    max-width: 95%;
                    padding: 32px;
                    border-radius: var(--radius-lg);
                }
            }

            @media (max-width: 480px) {
                .container {
                    max-width: 100%;
                    padding: 24px;
                    border-radius: var(--radius-md);
                }
            }

            /* Removed light spot effect */

            .quick-actions {
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                gap: 8px;
                z-index: 10;
            }

            .left-actions {
                position: absolute;
                top: 20px;
                left: 20px;
                z-index: 10;
            }


            .left-actions .action-btn svg {
                animation: none;
            }

            .left-actions .action-btn:hover svg {
                animation: none;
            }
            .action-btn {
                width: 44px;
                height: 44px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: var(--radius-md);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                box-shadow:
                    0 6px 20px rgba(0, 0, 0, 0.15),
                    0 2px 6px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1),
                    inset 0 -1px 0 rgba(255, 255, 255, 0.05);
                overflow: hidden;
            }

            /* Huly.io-style Texture Masking for Action Buttons - REMOVED */
            .action-btn::before {
                display: none;
            }

            @keyframes iconShine {
                0% {
                    left: -100%;
                }
                50% {
                    left: 100%;
                }
                100% {
                    left: 100%;
                }
            }

            .action-btn:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            }

            .action-btn svg {
                width: 20px;
                height: 20px;
                stroke: var(--text-secondary);
                fill: none;
                stroke-width: 2;
                transition: stroke 0.3s;
                animation: iconFloat 3s ease-in-out infinite;
            }

            .action-btn:hover svg {
                stroke: var(--text-primary);
                animation: iconSpin 0.6s ease-in-out;
            }

            @keyframes iconFloat {
                0%,
                100% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-3px);
                }
            }

            @keyframes iconSpin {
                0% {
                    transform: rotate(0deg) scale(1);
                }
                50% {
                    transform: rotate(180deg) scale(1.1);
                }
                100% {
                    transform: rotate(360deg) scale(1);
                }
            }

            .action-btn .tooltip {
                position: absolute;
                bottom: -35px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 6px 12px;
                border-radius: var(--radius-sm);
                font-size: 12px;
                white-space: nowrap;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .action-btn:hover .tooltip {
                opacity: 1;
            }

            .header {
                text-align: center;
                margin-bottom: 28px;
                position: relative;
            }

            .logo {
                margin-bottom: 16px;
            }

            .logo h1 {
                font-size: 32px;
                font-weight: 700;
                color: var(--text-primary);
                font-family: "Space Grotesk", sans-serif;
                margin-bottom: 8px;
                background: linear-gradient(
                    135deg,
                    #fff,
                    rgba(255, 255, 255, 0.8)
                );
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                filter: drop-shadow(0 2px 10px rgba(107, 107, 107, 0.3));
            }

            .logo .ui {
                color: #8b5cf6;
                background: linear-gradient(135deg, #8b5cf6, #a78bfa);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                filter: drop-shadow(0 2px 20px rgba(139, 92, 246, 0.5));
            }

            .subtitle {
                color: var(--text-secondary);
                font-size: 0.875rem;
                text-transform: uppercase;
                letter-spacing: 0.2em;
                font-weight: 500;
                background: linear-gradient(
                    90deg,
                    var(--text-secondary),
                    var(--text-primary),
                    var(--text-secondary)
                );
                background-size: 200% 100%;
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: shimmer 3s linear infinite;
            }

            .status-card {
                background: rgba(255, 255, 255, 0.06);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: var(--radius-xl);
                padding: 14px;
                margin-bottom: 20px;
                position: relative;
                overflow: hidden;
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
                transition:
                    border-color 0.3s ease,
                    box-shadow 0.3s ease;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .status-card:hover {
                border-color: rgba(107, 107, 107, 0.4);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 20px rgba(107, 107, 107, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            /* Huly.io-style Advanced Glow Effect - REMOVED */
            .status-card::before {
                display: none;
            }

            /* Dynamic Glass Shine */
            .status-card::after {
                content: "";
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: conic-gradient(
                    from 0deg,
                    transparent 0deg,
                    rgba(255, 255, 255, 0.15) 45deg,
                    rgba(255, 255, 255, 0.3) 90deg,
                    transparent 135deg,
                    transparent 360deg
                );
                animation: glassRotate 12s linear infinite;
                pointer-events: none;
                z-index: 2;
            }

            @keyframes ripple {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                100% {
                    transform: scale(2);
                    opacity: 0;
                }
            }

            /* Dynamic Glass Shine - REMOVED */
            .status-card::after {
                display: none;
            }

            .status-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0;
                position: relative;
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 10px;
            }

            .status-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: linear-gradient(135deg, #10b981, #34d399);
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
                position: relative;
                animation: pulse 2s infinite;
            }

            .status-dot::after {
                content: "";
                position: absolute;
                top: -4px;
                left: -4px;
                right: -4px;
                bottom: -4px;
                border-radius: 50%;
                background: inherit;
                opacity: 0.3;
                animation: pulse 2s infinite;
            }

            .status-dot.inactive {
                background: #666;
                box-shadow: none;
                animation: none;
            }

            .status-dot.inactive::after {
                display: none;
            }

            .status-dot.initializing {
                background: linear-gradient(135deg, #f59e0b, #fbbf24);
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
                animation: pulse 2s infinite;
            }

            .status-dot.error {
                background: linear-gradient(135deg, #ef4444, #f87171);
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
                animation: none;
            }

            .status-dot.error::after {
                display: none;
            }

            .status-dot.starting {
                background: linear-gradient(135deg, #6b7280, #9ca3af);
                box-shadow: 0 0 20px rgba(107, 114, 128, 0.4);
                animation: pulse 3s infinite;
            }

            .status-text {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
            }

            .profile-section {
                margin-bottom: 16px;
                animation: slideInUp 0.8s ease-out 0.3s both;
            }

            .form-label {
                display: block;
                margin-bottom: 12px;
                color: var(--text-secondary);
                text-transform: uppercase;
                font-size: 0.8rem;
                letter-spacing: 0.15em;
                font-weight: 600;
                font-family: "Space Grotesk", sans-serif;
            }

            .select-wrapper {
                position: relative;
            }

            .select-wrapper::before {
                content: "";
                position: absolute;
                left: 16px;
                top: 50%;
                transform: translateY(-50%);
                width: 18px;
                height: 18px;
                z-index: 2;
                pointer-events: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='12' cy='7' r='4'%3E%3C/circle%3E%3C/svg%3E");
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }

            select {
                width: 100%;
                padding: 12px 44px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-lg);
                font-size: 15px;
                color: var(--text-primary);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                outline: none;
                font-family: "Inter", sans-serif;
                font-weight: 500;
                cursor: pointer;
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 16px center;
                background-size: 20px;
            }

            select:focus {
                border-color: rgba(139, 92, 246, 0.5);
                background-color: rgba(255, 255, 255, 0.08);
                box-shadow:
                    0 0 0 4px rgba(139, 92, 246, 0.15),
                    0 10px 30px rgba(0, 0, 0, 0.2);
            }

            select:hover {
                border-color: rgba(139, 92, 246, 0.4);
                background-color: rgba(255, 255, 255, 0.07);
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
            }

            select option {
                background: #1a1a1a;
                color: #ffffff;
                padding: 10px;
            }

            select option:disabled {
                color: rgba(255, 255, 255, 0.3);
            }

            select:has(option:disabled:checked) {
                color: rgba(255, 255, 255, 0.4);
            }

            .auto-open-section {
                margin: 12px 0;
                padding: 10px 0;
            }

            .auto-open-section::before {
                display: none;
            }

            @keyframes checkboxShine {
                0% {
                    left: -100%;
                }
                50% {
                    left: 100%;
                }
                100% {
                    left: 100%;
                }
            }

            .checkbox-label {
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
                user-select: none;
            }

            .checkbox-input {
                width: 20px;
                height: 20px;
                cursor: pointer;
                accent-color: #8b5cf6;
                border: 2px solid rgba(255, 255, 255, 0.2);
                border-radius: var(--radius-xs);
            }

            .checkbox-text {
                color: var(--text-secondary);
                font-size: 14px;
                font-family: "Inter", sans-serif;
            }

            .checkbox-label:hover .checkbox-text {
                color: var(--text-primary);
            }

            .add-user-section {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }

            .add-user-section input {
                flex: 1;
                padding: 14px 16px;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 2px solid var(--glass-border);
                border-radius: var(--radius-md);
                color: var(--text-primary);
                font-size: 14px;
                outline: none;
                transition: all 0.3s;
            }

            .add-user-section input:focus {
                border-color: rgba(107, 107, 107, 0.3);
                background-color: rgba(255, 255, 255, 0.03);
            }

            .add-user-section button {
                padding: 14px 20px;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 2px solid var(--glass-border);
                border-radius: var(--radius-md);
                color: var(--text-primary);
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }

            .add-user-section button:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
            }

            .settings-toggle {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px 16px;
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: var(--radius-md);
                margin-bottom: 16px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .settings-toggle:hover {
                background: rgba(255, 255, 255, 0.03);
                border-color: rgba(255, 255, 255, 0.12);
            }

            .toggle-label {
                font-size: 14px;
                color: var(--text-secondary);
            }

            .toggle-switch {
                position: relative;
                width: 48px;
                height: 24px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-md);
                transition: background 0.3s;
            }

            .toggle-switch.active {
                background: rgba(107, 107, 107, 0.3);
            }

            .toggle-switch::after {
                content: "";
                position: absolute;
                width: 18px;
                height: 18px;
                background: white;
                border-radius: 50%;
                top: 3px;
                left: 3px;
                transition: transform 0.3s;
            }

            .toggle-switch.active::after {
                transform: translateX(24px);
                background: var(--primary);
            }

            .actions-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 16px;
            }

            /* Responsive grid adjustments */
            @media (max-width: 768px) {
                .actions-grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
            }

            @media (max-width: 576px) {
                .actions-grid {
                    gap: 10px;
                }
            }

            .btn {
                padding: 14px 20px;
                border: none;
                border-radius: var(--radius-xl);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                font-family: "Space Grotesk", sans-serif;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                animation: scaleIn 0.6s ease-out 0.4s both;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 48px;
            }

            /* Responsive button adjustments */
            @media (max-width: 768px) {
                .btn {
                    padding: 16px 20px;
                    font-size: 15px;
                    min-height: 52px;
                }
            }

            @media (max-width: 576px) {
                .btn {
                    padding: 14px 18px;
                    font-size: 14px;
                    min-height: 48px;
                    border-radius: var(--radius-lg);
                }
            }

            @media (max-width: 480px) {
                .btn {
                    padding: 12px 16px;
                    font-size: 13px;
                    min-height: 44px;
                    border-radius: var(--radius-md);
                }
            }

            .btn-primary {
                grid-column: 1 / -1;
                background:
                    linear-gradient(
                        135deg,
                        rgba(139, 92, 246, 0.4),
                        rgba(124, 58, 237, 0.25)
                    ),
                    linear-gradient(
                        45deg,
                        rgba(255, 255, 255, 0.15) 0%,
                        transparent 50%,
                        rgba(255, 255, 255, 0.08) 100%
                    );
                backdrop-filter: blur(25px) saturate(180%) brightness(120%)
                    contrast(110%);
                -webkit-backdrop-filter: blur(25px) saturate(180%)
                    brightness(120%) contrast(110%);
                color: white;
                border: 1px solid rgba(139, 92, 246, 0.5);
                box-shadow:
                    0 8px 20px rgba(91, 33, 182, 0.3),
                    0 4px 10px rgba(0, 0, 0, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(139, 92, 246, 0.3);
                position: relative;
                overflow: hidden;
            }

            /* Removed button light spot effects for cleaner look */

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-3px) scale(1.02);
                box-shadow:
                    0 0 30px rgba(139, 92, 246, 0.4),
                    0 20px 40px rgba(91, 33, 182, 0.3),
                    0 10px 20px rgba(0, 0, 0, 0.3);
                background: linear-gradient(
                    135deg,
                    rgba(139, 92, 246, 0.5),
                    rgba(124, 58, 237, 0.35)
                );
                border-color: rgba(167, 139, 250, 0.6);
            }

            .btn-success {
                grid-column: 1 / -1;
                background:
                    linear-gradient(
                        135deg,
                        rgba(34, 211, 238, 0.35),
                        rgba(139, 92, 246, 0.25)
                    ),
                    linear-gradient(
                        45deg,
                        rgba(255, 255, 255, 0.15) 0%,
                        transparent 50%,
                        rgba(255, 255, 255, 0.08) 100%
                    );
                backdrop-filter: blur(25px) saturate(180%) brightness(120%)
                    contrast(110%);
                -webkit-backdrop-filter: blur(25px) saturate(180%)
                    brightness(120%) contrast(110%);
                color: white;
                border: 1px solid rgba(34, 211, 238, 0.5);
                box-shadow:
                    0 8px 20px rgba(34, 211, 238, 0.2),
                    0 4px 10px rgba(0, 0, 0, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(34, 211, 238, 0.2);
            }

            .btn-success:hover:not(:disabled) {
                transform: translateY(-3px) scale(1.02);
                box-shadow: 0 0 25px rgba(34, 211, 238, 0.3);
                background: linear-gradient(
                    135deg,
                    rgba(34, 211, 238, 0.5),
                    rgba(139, 92, 246, 0.35)
                );
            }

            .btn-secondary {
                background:
                    linear-gradient(
                        135deg,
                        rgba(107, 107, 107, 0.3),
                        rgba(107, 107, 107, 0.15)
                    ),
                    linear-gradient(
                        45deg,
                        rgba(255, 255, 255, 0.2) 0%,
                        transparent 50%,
                        rgba(255, 255, 255, 0.1) 100%
                    );
                backdrop-filter: blur(25px) saturate(180%) brightness(120%)
                    contrast(110%);
                -webkit-backdrop-filter: blur(25px) saturate(180%)
                    brightness(120%) contrast(110%);
                color: white;
                border: 1px solid rgba(107, 107, 107, 0.4);
                box-shadow:
                    0 8px 20px rgba(0, 0, 0, 0.3),
                    0 4px 10px rgba(0, 0, 0, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -1px 0 rgba(255, 255, 255, 0.1);
                padding: 12px 20px;
                font-size: 14px;
                min-height: 44px;
            }

            .btn-secondary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(107, 107, 107, 0.15);
                background: linear-gradient(135deg, #6b6b6b, #7b7b7b);
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none !important;
            }

            .btn:active:not(:disabled) {
                transform: translateY(-1px) scale(0.98);
                transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Ripple effect */
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.5);
                transform: scale(0);
                animation: ripple-animation 0.6s ease-out;
                pointer-events: none;
            }

            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }

            .btn-loading {
                background: linear-gradient(
                    135deg,
                    rgba(100, 100, 100, 0.3),
                    rgba(80, 80, 80, 0.2)
                ) !important;
                color: rgba(255, 255, 255, 0.5) !important;
                border-color: rgba(150, 150, 150, 0.3) !important;
                cursor: wait !important;
                pointer-events: none;
            }

            .btn-loading:hover {
                transform: none !important;
                box-shadow: none !important;
            }

            .resource-monitor {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-top: 24px;
                padding: 16px;
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: var(--radius-lg);
            }

            .resource-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .resource-icon {
                width: 32px;
                height: 32px;
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.05),
                    rgba(255, 255, 255, 0.02)
                );
                border-radius: var(--radius-sm);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
            }

            .resource-info {
                flex: 1;
            }

            .resource-label {
                font-size: 11px;
                color: var(--text-tertiary);
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }

            .resource-value {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .footer {
                text-align: center;
                margin-top: auto;
                padding: 40px 20px 30px;
                width: 100%;
                animation: fadeIn 1s ease-out 0.5s both;
                position: relative;
                z-index: 1;
            }

            .footer-links {
                display: flex;
                justify-content: center;
                gap: 24px;
                margin-bottom: 16px;
            }

            .footer-link {
                color: rgba(255, 255, 255, 0.4);
                text-decoration: none;
                font-size: 13px;
                transition: color 0.3s;
            }

            .footer-link:hover {
                color: rgba(255, 255, 255, 0.7);
            }

            .footer-copyright {
                color: rgba(255, 255, 255, 0.25);
                font-size: 11px;
                margin-top: 8px;
            }

            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .loading-overlay.active {
                display: flex;
            }

            .loading-content {
                text-align: center;
            }

            .spinner {
                border: 3px solid rgba(255, 255, 255, 0.1);
                border-top: 3px solid var(--primary);
                border-radius: 50%;
                width: 48px;
                height: 48px;
                animation: spin 1s linear infinite;
                margin: 0 auto 24px;
                box-shadow: 0 0 20px rgba(107, 107, 107, 0.3);
            }

            .loading-text {
                color: var(--text-primary);
                font-size: 14px;
                font-weight: 500;
                margin-bottom: 8px;
            }

            .loading-subtext {
                color: var(--text-tertiary);
                font-size: 14px;
            }

            .loading-progress {
                margin-top: 16px;
                font-size: 12px;
                color: var(--text-secondary);
            }

            /* ComfyViewer styles removed - use ComfyUI-Gallery instead */

            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: var(--radius-md);
                display: none;
                font-size: 14px;
                font-weight: 500;
                animation: slideInUp 0.4s ease-out;
                backdrop-filter: blur(10px);
                z-index: 1001;
                max-width: 320px;
            }

            .toast.success {
                background: linear-gradient(
                    135deg,
                    rgba(34, 197, 94, 0.9),
                    rgba(34, 197, 94, 0.7)
                );
                color: white;
            }

            .toast.error {
                background: linear-gradient(
                    135deg,
                    rgba(239, 68, 68, 0.9),
                    rgba(239, 68, 68, 0.7)
                );
                color: white;
            }

            .toast.info {
                background: linear-gradient(
                    135deg,
                    rgba(107, 107, 107, 0.9),
                    rgba(107, 107, 107, 0.7)
                );
                color: white;
            }

            @media (max-width: 480px) {
                .container {
                    padding: 32px 24px;
                    border-radius: 24px;
                }

                .logo h1 {
                    font-size: 32px;
                }

                .subtitle {
                    font-size: 12px;
                }

                .btn {
                    padding: 16px 20px;
                    font-size: 14px;
                }

                select {
                    padding: 14px 44px;
                    font-size: 14px;
                }

                .actions-grid {
                    grid-template-columns: 1fr;
                }

                .status-details {
                    /* Already centered with flexbox, no changes needed */
                }

                .resource-monitor {
                    grid-template-columns: 1fr;
                }
            }

            @media (prefers-reduced-motion: reduce) {
                * {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }

            /* Dramatic Background Gradients */
            .dramatic-bg {
                position: fixed;
                inset: 0;
                z-index: 0;
                pointer-events: none;
                overflow: hidden;
            }

            .gradient-orb {
                position: absolute;
                border-radius: 50%;
                filter: blur(100px);
                animation: float 8s ease-in-out infinite;
            }

            .orb-1 {
                width: 600px;
                height: 600px;
                background: radial-gradient(
                    circle,
                    rgba(255, 0, 100, 0.4) 0%,
                    rgba(255, 0, 100, 0.1) 50%,
                    transparent 100%
                );
                top: -200px;
                left: -200px;
                animation-delay: 0s;
            }

            .orb-2 {
                width: 500px;
                height: 500px;
                background: radial-gradient(
                    circle,
                    rgba(0, 200, 255, 0.4) 0%,
                    rgba(0, 200, 255, 0.1) 50%,
                    transparent 100%
                );
                top: 50%;
                right: -150px;
                animation-delay: 2s;
            }

            .orb-3 {
                width: 700px;
                height: 700px;
                background: radial-gradient(
                    circle,
                    rgba(255, 100, 0, 0.3) 0%,
                    rgba(255, 100, 0, 0.1) 50%,
                    transparent 100%
                );
                bottom: -300px;
                left: 30%;
                animation-delay: 4s;
            }

            .orb-4 {
                width: 400px;
                height: 400px;
                background: radial-gradient(
                    circle,
                    rgba(150, 0, 255, 0.4) 0%,
                    rgba(150, 0, 255, 0.1) 50%,
                    transparent 100%
                );
                top: 20%;
                left: 60%;
                animation-delay: 6s;
            }

            @keyframes float {
                0%,
                100% {
                    transform: translate(0, 0) scale(1);
                }
                25% {
                    transform: translate(30px, -20px) scale(1.1);
                }
                50% {
                    transform: translate(-20px, 30px) scale(0.9);
                }
                75% {
                    transform: translate(20px, 20px) scale(1.05);
                }
            }

            /* Smart UI Box - No entrance animation */
            .main-wrapper {
                opacity: 1;
                transform: translateY(0);
                width: 100%;
                max-width: 560px;
                margin: 0 auto;
                padding: 14px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* Smart Button Interactions */
            .btn-primary {
                position: relative;
                overflow: hidden;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform-style: preserve-3d;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(231, 51, 29, 0.25);
                background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            }

            .btn-primary:active {
                transform: translateY(0);
                transition: all 0.1s ease;
            }

            /* Smart Icon Interactions */
            .action-btn {
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
            }

            .action-btn:hover {
                transform: translateY(-2px) scale(1.05);
                background: rgba(255, 255, 255, 0.1);
                box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
            }

            .action-btn:active {
                transform: translateY(0) scale(1.02);
                transition: all 0.1s ease;
            }

            /* Smart Status Dot - Only pulses when inactive */
            .status-dot.inactive {
                animation: smartPulse 3s ease-in-out infinite;
            }

            .status-dot.initializing {
                animation: smartPulse 1.5s ease-in-out infinite;
            }

            .status-dot.ready {
                animation: none;
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            }

            @keyframes smartPulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.1);
                    opacity: 0.7;
                }
            }

            /* Smart Card Glow - Subtle breathing effect */
            .glow-effect {
                animation: smartGlow 4s ease-in-out infinite;
            }

            @keyframes smartGlow {
                0%,
                100% {
                    box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
                }
                50% {
                    box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
                }
            }

            /* No floating animation */
            .floating {
                animation: none;
            }

            /* Smart Focus States */
            .btn-primary:focus-visible {
                outline: 2px solid rgba(107, 107, 107, 0.5);
                outline-offset: 2px;
            }

            .action-btn:focus-visible {
                outline: 2px solid rgba(255, 255, 255, 0.5);
                outline-offset: 2px;
            }

            /* Smart Loading States */
            .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            /* Smart Hover Zones */
            .card:hover {
                transform: translateY(-1px);
                transition: transform 0.2s ease;
            }

            /* Typing Cursor Animation */
            .typing-cursor {
                color: var(--primary);
                animation: blink 0.8s infinite;
                font-weight: bold;
                font-size: inherit;
                margin-left: 2px;
                background: rgba(107, 107, 107, 0.2);
                padding: 0 2px;
                border-radius: 3px;
            }

            @keyframes blink {
                0%,
                50% {
                    opacity: 1;
                }
                51%,
                100% {
                    opacity: 0.3;
                }
            }

            /* Ripple Effect */
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0);
                animation: ripple-animation 0.6s linear;
                pointer-events: none;
            }

            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }

            /* Fade In Animation */
            .animate-fade-in {
                animation: fadeInUp 0.8s ease-out forwards;
                opacity: 0;
                transform: translateY(30px);
            }

            @keyframes fadeInUp {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* ===== Add User Button & Modal Styles ===== */

            /* Add User Button */
            .btn-add-user {
                margin-top: 12px;
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 8px;
                color: rgba(255, 255, 255, 0.6);
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                width: 100%;
            }

            .btn-add-user:hover {
                background: rgba(139, 92, 246, 0.15);
                border-color: rgba(139, 92, 246, 0.3);
                color: rgba(255, 255, 255, 0.9);
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(139, 92, 246, 0.15);
            }

            .btn-add-user:active {
                transform: translateY(0);
            }

            /* Modal Overlay */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10000;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            /* Modal Content */
            .modal-content {
                background: rgba(20, 20, 20, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 16px;
                width: 90%;
                max-width: 480px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                animation: slideUp 0.3s ease;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            /* Modal Header */
            .modal-header {
                padding: 24px 24px 16px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.95);
            }

            .modal-close {
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.5);
                font-size: 28px;
                line-height: 1;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            .modal-close:hover {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.9);
            }

            /* Modal Body */
            .modal-body {
                padding: 24px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group:last-child {
                margin-bottom: 0;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.8);
            }

            .form-group input {
                width: 100%;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 8px;
                color: rgba(255, 255, 255, 0.95);
                font-size: 14px;
                font-family: "Inter", sans-serif;
                transition: all 0.2s ease;
                box-sizing: border-box;
            }

            .form-group input:focus {
                outline: none;
                border-color: rgba(107, 107, 107, 0.5);
                background: rgba(255, 255, 255, 0.08);
            }

            .form-hint {
                display: block;
                margin-top: 6px;
                font-size: 12px;
                color: rgba(255, 255, 255, 0.5);
                line-height: 1.4;
            }

            /* Modal Footer */
            .modal-footer {
                padding: 16px 24px 24px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .modal-footer .btn {
                padding: 10px 24px;
                font-size: 14px;
                font-weight: 500;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: none;
            }

            .modal-footer .btn-secondary {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.7);
                border: 1px solid rgba(255, 255, 255, 0.12);
            }

            .modal-footer .btn-secondary:hover {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.9);
            }

            .modal-footer .btn-primary {
                background: linear-gradient(135deg, #6b6b6b, #888);
                color: white;
                border: none;
            }

            .modal-footer .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(107, 107, 107, 0.4);
            }

            .modal-footer .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .modal-footer .btn-primary:active:not(:disabled) {
                transform: translateY(0);
            }
        </style>
    </head>
    <body>
        <!-- DarkVeil WebGL Background -->
        <canvas
            id="darkVeilCanvas"
            style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 0;
                pointer-events: none;
                display: block;
            "
        ></canvas>

        <div class="main-wrapper" style="position: relative; z-index: 10">
            <div class="container glow-effect floating">
                <div class="left-actions">
                    <button class="action-btn" onclick="showAddUserModal()" title="Add new user">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
                        </svg>
                    </button>
                </div>
                <div class="quick-actions">
                    <button
                        class="action-btn"
                        onclick="openJupyterLab()"
                        id="jupyterLabBtn"
                    >
                        <lottie-player
                            src="https://assets-v2.lottiefiles.com/a/618e7af4-2595-11ee-ba4a-c726a07376ae/pwiyh1eZE5.json"
                            background="transparent"
                            speed="1"
                            style="width: 28px; height: 28px"
                            loop
                            autoplay
                        >
                        </lottie-player>
                    </button>
                    <button class="action-btn" onclick="openModelManager()">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                            />
                        </svg>
                    </button>
                </div>
                <div class="header">
                    <div class="logo">
                        <h1 id="title-text"></h1>
                </div>

                <div class="status-card">
                    <div class="status-header">
                        <div class="status-badge">
                            <div
                                class="status-dot {% if running %}{% else %}inactive{% endif %}"
                                id="statusDot"
                            ></div>
                            <div class="status-text" id="statusText">
                                {% if running %} Active  {{ current_user }} {%
                                else %} Offline {% endif %}
                            </div>
                        </div>
                        <div
                            style="
                                font-size: 12px;
                                color: var(--text-tertiary);
                                position: absolute;
                                right: 0;
                            "
                        >
                            v3
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="select-wrapper">
                        <select
                            id="username"
                            {%
                            if
                            running
                            %}disabled{%
                            endif
                            %}
                        >
                            {% if not current_user %}
                            <option value="" selected disabled>
                                Select User
                            </option>
                            {% endif %} {% for user in users %}
                            <option
                                value="{{ user }}" {% if user == current_user %}selected{% endif %}>
                                {{ user }}{% if user == 'serhii' %} (Admin){%
                                endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="auto-open-section">
                    <label class="checkbox-label">
                        <input
                            type="checkbox"
                            id="autoOpenCheckbox"
                            class="checkbox-input"
                        />
                        <span class="checkbox-text"
                            >Auto-open ComfyUI when ready</span
                        >
                    </label>
                </div>

                <div class="actions-grid" id="actionsGrid">
                    <button
                        class="btn btn-primary btn-advanced magnetic"
                        id="primaryBtn"
                        onclick="startComfyUI()"
                        {%
                        if
                        running
                        %}style="display: none;"
                        {%
                        elif
                        not
                        current_user
                        %}disabled{%
                        endif
                        %}
                    >
                        Launch ComfyUI
                    </button>
                    {% if running %}
                    <button
                        class="btn btn-success btn-advanced magnetic"
                        id="openBtn"
                        onclick="openComfyUI()"
                    >
                        Open ComfyUI
                    </button>
                    <button
                        class="btn btn-secondary btn-advanced magnetic"
                        id="restartBtn"
                        onclick="restartService()"
                    >
                        Restart
                    </button>
                    <button
                        class="btn btn-secondary btn-advanced magnetic"
                        id="stopBtn"
                        onclick="stopComfyUI()"
                    >
                        Stop
                    </button>
                    {% endif %}
                </div>

                <!-- ComfyViewer removed - users can install ComfyUI-Gallery from ComfyUI Manager -->
            </div>
        </div>

        <div class="footer">
            <div class="footer-links">
                <a
                    href="https://github.com/wolfgrimmm/comfyui-runpod-installer"
                    class="footer-link"
                    >GitHub</a
                >
                <a
                    href="https://github.com/comfyanonymous/ComfyUI"
                    class="footer-link"
                    >ComfyUI</a
                >
                <a href="https://www.runpod.io/" class="footer-link">RunPod</a>
            </div>
            <div class="footer-copyright"> 2025 Web Group Limited</div>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <!-- Lottie Loading Animation Container -->
                <div
                    id="lottieLoadingContainer"
                    style="width: 120px; height: 120px; margin: 0 auto"
                ></div>
                <div class="loading-text" id="loadingText">
                    Initializing ComfyUI
                </div>
                <div class="loading-subtext" id="loadingSubtext">
                    This may take a moment...
                </div>
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
        </div>

        <!-- Lottie Success Animation Container (positioned in status area) -->
        <div
            id="lottieSuccessContainer"
            style="
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 200px;
                height: 200px;
                z-index: 10000;
                display: none;
                pointer-events: none;
            "
        ></div>

        <!-- Lottie Error Animation Container -->
        <div
            id="lottieErrorContainer"
            style="
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 200px;
                height: 200px;
                z-index: 10000;
                display: none;
                pointer-events: none;
            "
        ></div>

        <div class="toast" id="toast"></div>

        <script>
            // Advanced Particle System (Huly.io style)
            // ============================================
            //  PREMIUM ANIMATION INITIALIZATION
            // Using GSAP + Atropos + Lottie for 60 FPS performance
            // ============================================

            document.addEventListener('DOMContentLoaded', () => {
                // Register GSAP plugins
                gsap.registerPlugin(ScrollTrigger);

                //  Micro-interactions: Ripple effect on all buttons
                document.querySelectorAll('.btn, .btn-primary, .btn-secondary, .btn-success, .action-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        // Don't add ripple if button is disabled
                        if (this.disabled) return;

                        const ripple = document.createElement('span');
                        ripple.classList.add('ripple');

                        const rect = this.getBoundingClientRect();
                        const size = Math.max(rect.width, rect.height);
                        const x = e.clientX - rect.left - size / 2;
                        const y = e.clientY - rect.top - size / 2;

                        ripple.style.width = ripple.style.height = size + 'px';
                        ripple.style.left = x + 'px';
                        ripple.style.top = y + 'px';

                        this.appendChild(ripple);

                        // Remove ripple after animation
                        setTimeout(() => ripple.remove(), 600);
                    });
                });

                //  Initialize Lottie Animations
                let loadingAnimation = null;
                let successAnimation = null;
                let errorAnimation = null;

                // Loading animation (Spinning dots - reliable public CDN)
                if (document.getElementById('lottieLoadingContainer')) {
                    loadingAnimation = lottie.loadAnimation({
                        container: document.getElementById('lottieLoadingContainer'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: false,
                        path: 'https://assets3.lottiefiles.com/packages/lf20_0apkn3k1.json'
                    });
                }

                // Success animation (Green checkmark - reliable public CDN)
                if (document.getElementById('lottieSuccessContainer')) {
                    successAnimation = lottie.loadAnimation({
                        container: document.getElementById('lottieSuccessContainer'),
                        renderer: 'svg',
                        loop: false,
                        autoplay: false,
                        path: 'https://assets4.lottiefiles.com/packages/lf20_zyquagfl.json'
                    });
                }

                // Error animation (we'll add this if needed)
                // For now, we'll just use the toast notification for errors

                // Helper functions to control animations
                window.showLottieLoading = function() {
                    if (loadingAnimation) {
                        document.getElementById('lottieLoadingContainer').style.display = 'block';
                        loadingAnimation.goToAndPlay(0);
                    }
                };

                window.hideLottieLoading = function() {
                    if (loadingAnimation) {
                        loadingAnimation.stop();
                        document.getElementById('lottieLoadingContainer').style.display = 'none';
                    }
                };

                window.showLottieSuccess = function() {
                    if (successAnimation) {
                        const container = document.getElementById('lottieSuccessContainer');
                        container.style.display = 'block';
                        successAnimation.goToAndPlay(0);

                        // Hide after animation completes
                        setTimeout(() => {
                            container.style.display = 'none';
                        }, 2000);
                    }
                };

                // 1. GSAP 3D Parallax Effect with LAYERED DEPTH
                const container = document.querySelector('.container');

                if (container) {
                    // Set up 3D perspective on container (maximum for extreme depth)
                    container.style.transformStyle = 'preserve-3d';
                    container.style.perspective = '1500px';

                    // Create depth layers for different elements
                    const depthLayers = {
                        content: document.querySelectorAll('.header'), // Middle layer - headers/titles
                        sections: document.querySelectorAll('.profile-section'), // Sections - Active Profile only
                        statCards: document.querySelectorAll('.stat-item'), // Stat cards (Uptime, Models, Queue)
                        buttons: document.querySelectorAll('#primaryBtn, .btn-primary, .btn-success, #actionsGrid .btn'), // Main action buttons
                        topIcons: document.querySelectorAll('.quick-actions .action-btn') // Top icons (closest)
                    };

                    // Apply initial Z-depth to layers
                    if (depthLayers.content) {
                        depthLayers.content.forEach(el => {
                            el.style.transform = 'translateZ(15px)';
                            el.style.transformStyle = 'preserve-3d';
                        });
                    }

                    if (depthLayers.sections) {
                        depthLayers.sections.forEach(el => {
                            el.style.transform = 'translateZ(30px)';
                            el.style.transformStyle = 'preserve-3d';
                        });
                    }

                    if (depthLayers.statCards) {
                        depthLayers.statCards.forEach(el => {
                            // Already has translateZ(40px) in CSS, just ensure preserve-3d
                            el.style.transformStyle = 'preserve-3d';
                        });
                    }

                    if (depthLayers.buttons) {
                        depthLayers.buttons.forEach(el => {
                            el.style.transform = 'translateZ(150px)';
                            el.style.transformStyle = 'preserve-3d';
                        });
                    }

                    if (depthLayers.topIcons) {
                        depthLayers.topIcons.forEach(el => {
                            el.style.transform = 'translateZ(85px)';
                            el.style.transformStyle = 'preserve-3d';
                        });
                    }

                    // Mouse move parallax with layered depth
                    document.addEventListener('mousemove', (e) => {
                        const rect = container.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const xAxis = (centerX - e.clientX) / 60;
                        const yAxis = (centerY - e.clientY) / 60;

                        // Rotate the entire container (increased rotation for stronger 3D)
                        gsap.to(container, {
                            rotationY: xAxis,
                            rotationX: yAxis,
                            duration: 0.4,
                            ease: 'power2.out',
                            transformPerspective: 1500,
                            transformOrigin: 'center'
                        });

                        // Move content layer (subtle)
                        depthLayers.content.forEach(el => {
                            gsap.to(el, {
                                x: -xAxis * 0.3,
                                y: -yAxis * 0.3,
                                duration: 0.5,
                                ease: 'power2.out'
                            });
                        });

                        // Move sections layer (Active Profile)
                        depthLayers.sections.forEach(el => {
                            gsap.to(el, {
                                x: -xAxis * 0.6,
                                y: -yAxis * 0.6,
                                duration: 0.5,
                                ease: 'power2.out'
                            });
                        });

                        // Move stat cards layer (Uptime, Models, Queue) - medium depth
                        depthLayers.statCards.forEach(el => {
                            gsap.to(el, {
                                x: -xAxis * 0.8,
                                y: -yAxis * 0.8,
                                duration: 0.5,
                                ease: 'power2.out'
                            });
                        });

                        // Move buttons layer (Launch ComfyUI button, etc) - enhanced parallax movement
                        depthLayers.buttons.forEach(el => {
                            gsap.to(el, {
                                x: -xAxis * 2.5,
                                y: -yAxis * 2.5,
                                duration: 0.3,
                                ease: 'power2.out'
                            });
                        });

                        // Move top icons layer (most pronounced)
                        depthLayers.topIcons.forEach(el => {
                            gsap.to(el, {
                                x: -xAxis * 1.4,
                                y: -yAxis * 1.4,
                                duration: 0.5,
                                ease: 'power2.out'
                            });
                        });
                    });

                    // Reset on mouse leave
                    document.addEventListener('mouseleave', () => {
                        gsap.to(container, {
                            rotationY: 0,
                            rotationX: 0,
                            duration: 0.5,
                            ease: 'power2.out'
                        });

                        // Reset all layers
                        depthLayers.content.forEach(el => {
                            gsap.to(el, { x: 0, y: 0, duration: 0.5, ease: 'power2.out' });
                        });

                        depthLayers.sections.forEach(el => {
                            gsap.to(el, { x: 0, y: 0, duration: 0.5, ease: 'power2.out' });
                        });

                        depthLayers.buttons.forEach(el => {
                            gsap.to(el, { x: 0, y: 0, duration: 0.5, ease: 'power2.out' });
                        });

                        depthLayers.topIcons.forEach(el => {
                            gsap.to(el, { x: 0, y: 0, duration: 0.5, ease: 'power2.out' });
                        });
                    });
                }

                // 2. GSAP Magnetic Cursor Effect on Buttons
                const buttons = document.querySelectorAll('.btn, .action-btn');

                buttons.forEach(button => {
                    button.addEventListener('mouseenter', (e) => {
                        gsap.to(button, {
                            scale: 1.05,
                            duration: 0.3,
                            ease: 'power2.out'
                        });
                    });

                    button.addEventListener('mouseleave', (e) => {
                        gsap.to(button, {
                            scale: 1,
                            x: 0,
                            y: 0,
                            duration: 0.3,
                            ease: 'power2.out'
                        });
                    });

                    button.addEventListener('mousemove', (e) => {
                        const rect = button.getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width / 2;
                        const y = e.clientY - rect.top - rect.height / 2;

                        gsap.to(button, {
                            x: x * 0.1,
                            y: y * 0.1,
                            duration: 0.3,
                            ease: 'power2.out'
                        });
                    });
                });

                // 3. DarkVeil WebGL Background - Neural network generated shader
                (function initDarkVeil() {
                    const canvas = document.getElementById('darkVeilCanvas');
                    // OGL exports as lowercase 'ogl' in UMD build
                    const oglLib = window.OGL || window.ogl;
                    if (!canvas || !oglLib) {
                        console.warn('DarkVeil: Canvas or OGL not available');
                        return;
                    }

                    const { Renderer, Program, Mesh, Triangle, Vec2 } = oglLib;

                    // DarkVeil shader configuration
                    const config = {
                        hueShift: 0,
                        noiseIntensity: 0,
                        scanlineIntensity: 0,
                        speed: 0.5,
                        scanlineFrequency: 0,
                        warpAmount: 0,
                        resolutionScale: 1
                    };

                    const vertexShader = `
                        attribute vec2 position;
                        void main() {
                            gl_Position = vec4(position, 0.0, 1.0);
                        }
                    `;

                    const fragmentShader = `
                        #ifdef GL_ES
                        precision lowp float;
                        #endif
                        uniform vec2 uResolution;
                        uniform float uTime;
                        uniform float uHueShift;
                        uniform float uNoise;
                        uniform float uScan;
                        uniform float uScanFreq;
                        uniform float uWarp;
                        #define iTime uTime
                        #define iResolution uResolution

                        vec4 buf[8];
                        float rand(vec2 c) { return fract(sin(dot(c, vec2(12.9898, 78.233))) * 43758.5453); }

                        mat3 rgb2yiq = mat3(0.299, 0.587, 0.114, 0.596, -0.274, -0.322, 0.211, -0.523, 0.312);
                        mat3 yiq2rgb = mat3(1.0, 0.956, 0.621, 1.0, -0.272, -0.647, 1.0, -1.106, 1.703);

                        vec3 hueShiftRGB(vec3 col, float deg) {
                            vec3 yiq = rgb2yiq * col;
                            float rad = radians(deg);
                            float cosh = cos(rad), sinh = sin(rad);
                            vec3 yiqShift = vec3(yiq.x, yiq.y * cosh - yiq.z * sinh, yiq.y * sinh + yiq.z * cosh);
                            return clamp(yiq2rgb * yiqShift, 0.0, 1.0);
                        }

                        vec4 sigmoid(vec4 x) { return 1.0 / (1.0 + exp(-x)); }

                        vec4 cppn_fn(vec2 coordinate, float in0, float in1, float in2) {
                            buf[6] = vec4(coordinate.x, coordinate.y, 0.3948333106474662 + in0, 0.36 + in1);
                            buf[7] = vec4(0.14 + in2, sqrt(coordinate.x * coordinate.x + coordinate.y * coordinate.y), 0.0, 0.0);
                            buf[0] = mat4(vec4(6.5404263, -3.6126034, 0.7590882, -1.13613), vec4(2.4582713, 3.1660357, 1.2219609, 0.06276096), vec4(-5.478085, -6.159632, 1.8701609, -4.7742867), vec4(6.039214, -5.542865, -0.90925294, 3.251348)) * buf[6] + mat4(vec4(0.8473259, -5.722911, 3.975766, 1.6522468), vec4(-0.24321538, 0.5839259, -1.7661959, -5.350116), vec4(0.0, 0.0, 0.0, 0.0), vec4(0.0, 0.0, 0.0, 0.0)) * buf[7] + vec4(0.21808943, 1.1243913, -1.7969975, 5.0294676);
                            buf[1] = mat4(vec4(-3.3522482, -6.0612736, 0.55641043, -4.4719114), vec4(0.8631464, 1.7432913, 5.643898, 1.6106541), vec4(2.4941394, -3.5012043, 1.7184316, 6.357333), vec4(3.310376, 8.209261, 1.1355612, -1.165539)) * buf[6] + mat4(vec4(5.24046, -13.034365, 0.009859298, 15.870829), vec4(2.987511, 3.129433, -0.89023495, -1.6822904), vec4(0.0, 0.0, 0.0, 0.0), vec4(0.0, 0.0, 0.0, 0.0)) * buf[7] + vec4(-5.9457836, -6.573602, -0.8812491, 1.5436668);
                            buf[0] = sigmoid(buf[0]); buf[1] = sigmoid(buf[1]);
                            buf[2] = mat4(vec4(-15.219568, 8.095543, -2.429353, -1.9381982), vec4(-5.951362, 4.3115187, 2.6393783, 1.274315), vec4(-7.3145227, 6.7297835, 5.2473326, 5.9411426), vec4(5.0796127, 8.979051, -1.7278991, -1.158976)) * buf[6] + mat4(vec4(-11.967154, -11.608155, 6.1486754, 11.237008), vec4(2.124141, -6.263192, -1.7050359, -0.7021966), vec4(0.0, 0.0, 0.0, 0.0), vec4(0.0, 0.0, 0.0, 0.0)) * buf[7] + vec4(-4.17164, -3.2281182, -4.576417, -3.6401186);
                            buf[3] = mat4(vec4(3.1832156, -13.738922, 1.879223, 3.233465), vec4(0.64300746, 12.768129, 1.9141049, 0.50990224), vec4(-0.049295485, 4.4807224, 1.4733979, 1.801449), vec4(5.0039253, 13.000481, 3.3991797, -4.5561905)) * buf[6] + mat4(vec4(-0.1285731, 7.720628, -3.1425676, 4.742367), vec4(0.6393625, 3.714393, -0.8108378, -0.39174938), vec4(0.0, 0.0, 0.0, 0.0), vec4(0.0, 0.0, 0.0, 0.0)) * buf[7] + vec4(-1.1811101, -21.621881, 0.7851888, 1.2329718);
                            buf[2] = sigmoid(buf[2]); buf[3] = sigmoid(buf[3]);
                            buf[4] = mat4(vec4(5.214916, -7.183024, 2.7228765, 2.6592617), vec4(-5.601878, -25.3591, 4.067988, 0.4602802), vec4(-10.57759, 24.286327, 21.102104, 37.546658), vec4(4.3024497, -1.9625226, 2.3458803, -1.372816)) * buf[0] + mat4(vec4(-17.6526, -10.507558, 2.2587414, 12.462782), vec4(6.265566, -502.75443, -12.642513, 0.9112289), vec4(-10.983244, 20.741234, -9.701768, -0.7635988), vec4(5.383626, 1.4819539, -4.1911616, -4.8444734)) * buf[1] + mat4(vec4(12.785233, -16.345072, -0.39901125, 1.7955981), vec4(-30.48365, -1.8345358, 1.4542528, -1.1118771), vec4(19.872723, -7.337935, -42.941723, -98.52709), vec4(8.337645, -2.7312303, -2.2927687, -36.142323)) * buf[2] + mat4(vec4(-16.298317, 3.5471997, -0.44300047, -9.444417), vec4(57.5077, -35.609753, 16.163465, -4.1534753), vec4(-0.07470326, -3.8656476, -7.0901804, 3.1523974), vec4(-12.559385, -7.077619, 1.490437, -0.8211543)) * buf[3] + vec4(-7.67914, 15.927437, 1.3207729, -1.6686112);
                            buf[5] = mat4(vec4(-1.4109162, -0.372762, -3.770383, -21.367174), vec4(-6.2103205, -9.35908, 0.92529047, 8.82561), vec4(11.460242, -22.348068, 13.625772, -18.693201), vec4(-0.3429052, -3.9905605, -2.4626114, -0.45033523)) * buf[0] + mat4(vec4(7.3481627, -4.3661838, -6.3037653, -3.868115), vec4(1.5462853, 6.5488915, 1.9701879, -0.58291394), vec4(6.5858274, -2.2180402, 3.7127688, -1.3730392), vec4(-5.7973905, 10.134961, -2.3395722, -5.965605)) * buf[1] + mat4(vec4(-2.5132585, -6.6685553, -1.4029363, -0.16285264), vec4(-0.37908727, 0.53738135, 4.389061, -1.3024765), vec4(-0.70647055, 2.0111287, -5.1659346, -3.728635), vec4(-13.562562, 10.487719, -0.9173751, -2.6487076)) * buf[2] + mat4(vec4(-8.645013, 6.5546675, -6.3944063, -5.5933375), vec4(-0.57783127, -1.077275, 36.91025, 5.736769), vec4(14.283112, 3.7146652, 7.1452246, -4.5958776), vec4(2.7192075, 3.6021907, -4.366337, -2.3653464)) * buf[3] + vec4(-5.9000807, -4.329569, 1.2427121, 8.59503);
                            buf[4] = sigmoid(buf[4]); buf[5] = sigmoid(buf[5]);
                            buf[6] = mat4(vec4(-1.61102, 0.7970257, 1.4675229, 0.20917463), vec4(-28.793737, -7.1390953, 1.5025433, 4.656581), vec4(-10.94861, 39.66238, 0.74318546, -10.095605), vec4(-0.7229728, -1.5483948, 0.7301322, 2.1687684)) * buf[0] + mat4(vec4(3.2547753, 21.489103, -1.0194173, -3.3100595), vec4(-3.7316632, -3.3792162, -7.223193, -0.23685838), vec4(13.1804495, 0.7916005, 5.338587, 5.687114), vec4(-4.167605, -17.798311, -6.815736, -1.6451967)) * buf[1] + mat4(vec4(0.604885, -7.800309, -7.213122, -2.741014), vec4(-3.522382, -0.12359311, -0.5258442, 0.43852118), vec4(9.6752825, -22.853785, 2.062431, 0.099892326), vec4(-4.3196306, -17.730087, 2.5184598, 5.30267)) * buf[2] + mat4(vec4(-6.545563, -15.790176, -6.0438633, -5.415399), vec4(-43.591583, 28.551912, -16.00161, 18.84728), vec4(4.212382, 8.394307, 3.0958717, 8.657522), vec4(-5.0237565, -4.450633, -4.4768, -5.5010443)) * buf[3] + mat4(vec4(1.6985557, -67.05806, 6.897715, 1.9004834), vec4(1.8680354, 2.3915145, 2.5231109, 4.081538), vec4(11.158006, 1.7294737, 2.0738268, 7.386411), vec4(-4.256034, -306.24686, 8.258898, -17.132736)) * buf[4] + mat4(vec4(1.6889864, -4.5852966, 3.8534803, -6.3482175), vec4(1.3543309, -1.2640043, 9.932754, 2.9079645), vec4(-5.2770967, 0.07150358, -0.13962056, 3.3269649), vec4(28.34703, -4.918278, 6.1044083, 4.085355)) * buf[5] + vec4(6.6818056, 12.522166, -3.7075126, -4.104386);
                            buf[7] = mat4(vec4(-8.265602, -4.7027016, 5.098234, 0.7509808), vec4(8.6507845, -17.15949, 16.51939, -8.884479), vec4(-4.036479, -2.3946867, -2.6055532, -1.9866527), vec4(-2.2167742, -1.8135649, -5.9759874, 4.8846445)) * buf[0] + mat4(vec4(6.7790847, 3.5076547, -2.8191125, -2.7028968), vec4(-5.743024, -0.27844876, 1.4958696, -5.0517144), vec4(13.122226, 15.735168, -2.9397483, -4.101023), vec4(-14.375265, -5.030483, -6.2599335, 2.9848232)) * buf[1] + mat4(vec4(4.0950394, -0.94011575, -5.674733, 4.755022), vec4(4.3809423, 4.8310084, 1.7425908, -3.437416), vec4(2.117492, 0.16342592, -104.56341, 16.949184), vec4(-5.22543, -2.994248, 3.8350096, -1.9364246)) * buf[2] + mat4(vec4(-5.900337, 1.7946124, -13.604192, -3.8060522), vec4(6.6583457, 31.911177, 25.164474, 91.81147), vec4(11.840538, 4.1503043, -0.7314397, 6.768467), vec4(-6.3967767, 4.034772, 6.1714606, -0.32874924)) * buf[3] + mat4(vec4(3.4992442, -196.91893, -8.923708, 2.8142626), vec4(3.4806502, -3.1846354, 5.1725626, 5.1804223), vec4(-2.4009497, 15.585794, 1.2863957, 2.0252278), vec4(-71.25271, -62.441242, -8.138444, 0.50670296)) * buf[4] + mat4(vec4(-12.291733, -11.176166, -7.3474145, 4.390294), vec4(10.805477, 5.6337385, -0.9385842, -4.7348723), vec4(-12.869276, -7.039391, 5.3029537, 7.5436664), vec4(1.4593618, 8.91898, 3.5101583, 5.840625)) * buf[5] + vec4(2.2415268, -6.705987, -0.98861027, -2.117676);
                            buf[6] = sigmoid(buf[6]); buf[7] = sigmoid(buf[7]);
                            buf[0] = mat4(vec4(1.6794263, 1.3817469, 2.9625452, 0.0), vec4(-1.8834411, -1.4806935, -3.5924516, 0.0), vec4(-1.3279216, -1.0918057, -2.3124623, 0.0), vec4(0.2662234, 0.23235129, 0.44178495, 0.0)) * buf[0] + mat4(vec4(-0.6299101, -0.5945583, -0.9125601, 0.0), vec4(0.17828953, 0.18300213, 0.18182953, 0.0), vec4(-2.96544, -2.5819945, -4.9001055, 0.0), vec4(1.4195864, 1.1868085, 2.5176322, 0.0)) * buf[1] + mat4(vec4(-1.2584374, -1.0552157, -2.1688404, 0.0), vec4(-0.7200217, -0.52666044, -1.438251, 0.0), vec4(0.15345335, 0.15196142, 0.272854, 0.0), vec4(0.945728, 0.8861938, 1.2766753, 0.0)) * buf[2] + mat4(vec4(-2.4218085, -1.968602, -4.35166, 0.0), vec4(-22.683098, -18.0544, -41.954372, 0.0), vec4(0.63792, 0.5470648, 1.1078634, 0.0), vec4(-1.5489894, -1.3075932, -2.6444845, 0.0)) * buf[3] + mat4(vec4(-0.49252132, -0.39877754, -0.91366625, 0.0), vec4(0.95609266, 0.7923952, 1.640221, 0.0), vec4(0.30616966, 0.15693925, 0.8639857, 0.0), vec4(1.1825981, 0.94504964, 2.176963, 0.0)) * buf[4] + mat4(vec4(0.35446745, 0.3293795, 0.59547555, 0.0), vec4(-0.58784515, -0.48177817, -1.0614829, 0.0), vec4(2.5271258, 1.9991658, 4.6846647, 0.0), vec4(0.13042648, 0.08864098, 0.30187556, 0.0)) * buf[5] + mat4(vec4(-1.7718065, -1.4033192, -3.3355875, 0.0), vec4(3.1664357, 2.638297, 5.378702, 0.0), vec4(-3.1724713, -2.6107926, -5.549295, 0.0), vec4(-2.851368, -2.249092, -5.3013067, 0.0)) * buf[6] + mat4(vec4(1.5203838, 1.2212278, 2.8404984, 0.0), vec4(1.5210563, 1.2651345, 2.683903, 0.0), vec4(2.9789467, 2.4364579, 5.2347264, 0.0), vec4(2.2270417, 1.8825914, 3.8028636, 0.0)) * buf[7] + vec4(-1.5468478, -3.6171484, 0.24762098, 0.0);
                            buf[0] = sigmoid(buf[0]);
                            return vec4(buf[0].x, buf[0].y, buf[0].z, 1.0);
                        }

                        void mainImage(out vec4 fragColor, in vec2 fragCoord) {
                            vec2 uv = fragCoord / uResolution.xy * 2.0 - 1.0;
                            uv.y *= -1.0;
                            uv += uWarp * vec2(sin(uv.y * 6.283 + uTime * 0.5), cos(uv.x * 6.283 + uTime * 0.5)) * 0.05;
                            fragColor = cppn_fn(uv, 0.1 * sin(0.3 * uTime), 0.1 * sin(0.69 * uTime), 0.1 * sin(0.44 * uTime));
                        }

                        void main() {
                            vec4 col;
                            mainImage(col, gl_FragCoord.xy);
                            col.rgb = hueShiftRGB(col.rgb, uHueShift);
                            float scanline_val = sin(gl_FragCoord.y * uScanFreq) * 0.5 + 0.5;
                            col.rgb *= 1.0 - (scanline_val * scanline_val) * uScan;
                            col.rgb += (rand(gl_FragCoord.xy + uTime) - 0.5) * uNoise;
                            gl_FragColor = vec4(clamp(col.rgb, 0.0, 1.0), 1.0);
                        }
                    `;

                    const renderer = new Renderer({
                        dpr: Math.min(window.devicePixelRatio, 2),
                        canvas: canvas
                    });

                    const gl = renderer.gl;
                    const geometry = new Triangle(gl);

                    const program = new Program(gl, {
                        vertex: vertexShader,
                        fragment: fragmentShader,
                        uniforms: {
                            uTime: { value: 0 },
                            uResolution: { value: new Vec2() },
                            uHueShift: { value: config.hueShift },
                            uNoise: { value: config.noiseIntensity },
                            uScan: { value: config.scanlineIntensity },
                            uScanFreq: { value: config.scanlineFrequency },
                            uWarp: { value: config.warpAmount }
                        }
                    });

                    const mesh = new Mesh(gl, { geometry, program });

                    const resize = () => {
                        const w = window.innerWidth;
                        const h = window.innerHeight;
                        renderer.setSize(w * config.resolutionScale, h * config.resolutionScale);
                        program.uniforms.uResolution.value.set(w, h);
                    };

                    window.addEventListener('resize', resize);
                    resize();

                    const startTime = performance.now();

                    const loop = () => {
                        program.uniforms.uTime.value = ((performance.now() - startTime) / 1000) * config.speed;
                        renderer.render({ scene: mesh });
                        requestAnimationFrame(loop);
                    };

                    loop();
                })();

                // 4. GSAP Entrance Animations
                gsap.from('.container', {
                    y: 50,
                    opacity: 0,
                    duration: 0.8,
                    ease: 'power3.out'
                });

                // 5. Status Dot Pulse Animation
                const statusDot = document.querySelector('.status-dot');
                if (statusDot) {
                    gsap.to(statusDot, {
                        scale: 1.2,
                        opacity: 0.8,
                        duration: 1.5,
                        repeat: -1,
                        yoyo: true,
                        ease: 'power1.inOut'
                    });
                }

                // 6. Smooth Scroll Fade-in for Elements
                gsap.utils.toArray('.btn, .user-section, .status-indicator').forEach((elem, i) => {
                    gsap.from(elem, {
                        scrollTrigger: {
                            trigger: elem,
                            start: 'top 90%',
                            toggleActions: 'play none none reverse'
                        },
                        y: 30,
                        opacity: 0,
                        duration: 0.6,
                        delay: i * 0.1,
                        ease: 'power2.out'
                    });
                });

                // 7. Button Click Ripple Effect
                document.querySelectorAll('.btn, .action-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const ripple = document.createElement('span');
                        const rect = button.getBoundingClientRect();
                        const size = Math.max(rect.width, rect.height);
                        const x = e.clientX - rect.left - size / 2;
                        const y = e.clientY - rect.top - size / 2;

                        ripple.style.cssText = `
                            position: absolute;
                            width: ${size}px;
                            height: ${size}px;
                            left: ${x}px;
                            top: ${y}px;
                            background: rgba(255, 255, 255, 0.3);
                            border-radius: 50%;
                            pointer-events: none;
                            transform: scale(0);
                        `;

                        button.style.position = 'relative';
                        button.style.overflow = 'hidden';
                        button.appendChild(ripple);

                        gsap.to(ripple, {
                            scale: 2,
                            opacity: 0,
                            duration: 0.6,
                            ease: 'power2.out',
                            onComplete: () => ripple.remove()
                        });
                    });
                });

                // 8. Dropdown Smooth Animation
                const usernameSelect = document.querySelector('#username');
                if (usernameSelect) {
                    usernameSelect.addEventListener('change', () => {
                        gsap.fromTo(usernameSelect,
                            { scale: 0.95 },
                            { scale: 1, duration: 0.2, ease: 'back.out(1.7)' }
                        );
                    });
                }

                // 9. Toast Notification Enhancement
                const originalShowToast = window.showToast;
                window.showToast = function(message, type = 'info') {
                    originalShowToast(message, type);
                    const toast = document.getElementById('toast');
                    if (toast) {
                        gsap.fromTo(toast,
                            { y: -20, opacity: 0 },
                            { y: 0, opacity: 1, duration: 0.4, ease: 'power2.out' }
                        );
                    }
                };

                // 10. Custom Mouse Cursor - REMOVED (user didn't like it)

                // 11. Interactive Title Animation
                const titleText = document.getElementById('title-text');
                if (titleText) {
                    const text = titleText.textContent || 'ComfyUI Control';
                    titleText.innerHTML = text.split('').map((char, i) =>
                        `<span style="display: inline-block; transition: all 0.3s; cursor: default;">${char === ' ' ? '&nbsp;' : char}</span>`
                    ).join('');

                    const letters = titleText.querySelectorAll('span');
                    letters.forEach((letter, i) => {
                        letter.addEventListener('mouseenter', () => {
                            gsap.to(letter, {
                                y: -10,
                                color: 'var(--primary)',
                                scale: 1.3,
                                duration: 0.3,
                                ease: 'back.out(2)'
                            });
                        });

                        letter.addEventListener('mouseleave', () => {
                            gsap.to(letter, {
                                y: 0,
                                color: 'var(--text-primary)',
                                scale: 1,
                                duration: 0.3,
                                ease: 'power2.out'
                            });
                        });
                    });
                }

                // 12. Fun Easter Egg: Konami Code (BA)
                const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
                let konamiIndex = 0;

                document.addEventListener('keydown', (e) => {
                    if (e.key === konamiCode[konamiIndex]) {
                        konamiIndex++;
                        if (konamiIndex === konamiCode.length) {
                            // Easter egg activated!
                            gsap.to('.container', {
                                rotation: 360,
                                scale: 1.1,
                                duration: 1,
                                ease: 'back.out(1.7)',
                                onComplete: () => {
                                    gsap.to('.container', { rotation: 0, scale: 1, duration: 0.5 });
                                    showToast(' Konami Code Activated! You found the secret!', 'success');
                                }
                            });
                            konamiIndex = 0;
                        }
                    } else {
                        konamiIndex = 0;
                    }
                });
            });

            let checkInterval = null;
            let checkAttempts = 0;
            let initializationStartTime = null;
            let counterInterval = null;
            let lastStartTime = null;  // Track when ComfyUI was last started

            // Consolidated function to update UI when ComfyUI is running
            function updateUIForRunningState(username) {
                const primaryBtn = document.getElementById('primaryBtn');
                const actionsGrid = document.getElementById('actionsGrid');
                const usernameSelect = document.getElementById('username');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');

                // Clear initialization timer and counter since we're now active
                initializationStartTime = null;
                if (counterInterval) {
                    clearInterval(counterInterval);
                    counterInterval = null;
                }

                // Update status
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot';
                    statusText.textContent = `Active  ${username}`;
                }

                // Hide Launch button
                if (primaryBtn && primaryBtn.style.display !== 'none') {
                    primaryBtn.style.display = 'none';
                    primaryBtn.disabled = false;
                    primaryBtn.classList.remove('btn-loading');
                    primaryBtn.textContent = 'Launch ComfyUI';
                }

                // Create action buttons if they don't exist
                if (actionsGrid) {
                    if (!document.getElementById('openBtn')) {
                        const openBtn = document.createElement('button');
                        openBtn.className = 'btn btn-success';  // Green button with glow
                        openBtn.id = 'openBtn';
                        openBtn.textContent = 'Open ComfyUI';
                        openBtn.onclick = openComfyUI;
                        actionsGrid.appendChild(openBtn);

                        // Play success sound and show Lottie animation
                        playSuccessSound();
                        if (typeof showLottieSuccess === 'function') {
                            showLottieSuccess();
                        }

                        // Auto-open if checkbox is checked
                        const autoOpenCheckbox = document.getElementById('autoOpenCheckbox');
                        if (autoOpenCheckbox && autoOpenCheckbox.checked) {
                            // Small delay to let user see the success state
                            setTimeout(() => {
                                openComfyUI();
                            }, 500);
                        }
                    } else {
                        // Button already exists, just update its class to green
                        const existingBtn = document.getElementById('openBtn');
                        if (existingBtn && !existingBtn.className.includes('btn-success')) {
                            existingBtn.className = 'btn btn-success';
                        }
                    }

                    if (!document.getElementById('restartBtn')) {
                        const restartBtn = document.createElement('button');
                        restartBtn.className = 'btn btn-secondary';
                        restartBtn.id = 'restartBtn';
                        restartBtn.textContent = 'Restart';
                        restartBtn.onclick = restartService;
                        actionsGrid.appendChild(restartBtn);
                    }

                    if (!document.getElementById('stopBtn')) {
                        const stopBtn = document.createElement('button');
                        stopBtn.className = 'btn btn-secondary';
                        stopBtn.id = 'stopBtn';
                        stopBtn.textContent = 'Stop';
                        stopBtn.onclick = stopComfyUI;
                        actionsGrid.appendChild(stopBtn);
                    }
                }

                // Disable user selection when running
                if (usernameSelect) {
                    usernameSelect.disabled = true;
                }
            }

            // Enable/disable Launch button based on user selection
            document.addEventListener('DOMContentLoaded', () => {
                const usernameSelect = document.getElementById('username');
                const primaryBtn = document.getElementById('primaryBtn');

                if (usernameSelect && primaryBtn) {
                    // Style the select based on selection
                    function updateSelectStyle() {
                        if (!usernameSelect.value || usernameSelect.value === '') {
                            usernameSelect.style.color = 'rgba(255, 255, 255, 0.4)';
                        } else {
                            usernameSelect.style.color = '';
                        }
                    }

                    updateSelectStyle(); // Initial style

                    usernameSelect.addEventListener('change', (e) => {
                        updateSelectStyle();
                        if (e.target.value && e.target.value !== '') {
                            primaryBtn.disabled = false;
                        } else {
                            primaryBtn.disabled = true;
                        }
                    });
                }
            });

            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 4000);
            }

            function showLoading(show, text = 'Processing...', subtext = '') {
                const overlay = document.getElementById('loadingOverlay');
                if (show) {
                    document.getElementById('loadingText').textContent = text;
                    document.getElementById('loadingSubtext').textContent = subtext;
                    document.getElementById('loadingProgress').textContent = '';
                    overlay.classList.add('active');
                    // Start Lottie loading animation
                    if (typeof showLottieLoading === 'function') {
                        showLottieLoading();
                    }
                } else {
                    overlay.classList.remove('active');
                    // Stop Lottie loading animation
                    if (typeof hideLottieLoading === 'function') {
                        hideLottieLoading();
                    }
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                }
            }

            function getRunPodUrl(port) {
                const currentUrl = window.location.href;

                if (currentUrl.includes('proxy.runpod.net')) {
                    const matches = currentUrl.match(/https:\/\/([^-]+)-\d+\.proxy\.runpod\.net/);
                    if (matches) {
                        return `https://${matches[1]}-${port}.proxy.runpod.net/`;
                    }
                }

                return `http://${window.location.hostname}:${port}`;
            }

            async function checkComfyUIStatus(updateUI = true) {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();

                    if (!updateUI) {
                        return data;
                    }

                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');

                    if (data.running && data.ready) {
                        // ComfyUI is fully ready - update UI immediately
                        const username = data.current_user || 'User';
                        updateUIForRunningState(username);
                        return data;
                    } else if (data.running && !data.ready) {
                        // ComfyUI is running but not ready yet
                        statusDot.className = 'status-dot initializing';
                        statusText.textContent = 'Initializing  ComfyUI starting...';

                        // Continue checking
                        setTimeout(() => checkComfyUIStatus(true), 2000);
                        return data;
                    } else {
                        // ComfyUI is not running - but check if we recently started it
                        const STARTUP_WINDOW = 20 * 60 * 1000; // 20 minutes
                        const withinStartupWindow = lastStartTime && (Date.now() - lastStartTime < STARTUP_WINDOW);

                        if (withinStartupWindow) {
                            // Recently started - keep showing initializing
                            const elapsed = Math.floor((Date.now() - lastStartTime) / 1000);
                            const minutes = Math.floor(elapsed / 60);
                            const seconds = elapsed % 60;
                            const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                            statusDot.className = 'status-dot initializing';
                            statusText.textContent = `Initializing  ${timeStr} elapsed`;
                        } else {
                            // Not within startup window - actually inactive
                            statusDot.className = 'status-dot inactive';
                            statusText.textContent = 'Offline';
                        }
                        return data;
                    }
                } catch (error) {
                    // Check if this is a JSON parse error during startup
                    const isJsonError = error.message && (
                        error.message.includes('JSON') ||
                        error.message.includes('Unexpected token') ||
                        error.message.includes('SyntaxError')
                    );

                    // Silently handle JSON errors during startup (they're expected)
                    if (isJsonError) {
                        // Don't log or show errors - this is normal during ComfyUI initialization
                        if (updateUI) {
                            // If we're actively checking during startup, retry gracefully
                            setTimeout(() => checkComfyUIStatus(true), 3000);
                        }
                        return { running: true, ready: false, initializing: true };
                    }

                    // Only log non-JSON errors
                    console.error('Status check error:', error);

                    // For other errors, show error state only if we're updating UI
                    if (updateUI) {
                        const statusDot = document.getElementById('statusDot');
                        const statusText = document.getElementById('statusText');
                        statusDot.className = 'status-dot error';
                        statusText.textContent = 'Error  Cannot check status';
                    }
                    return { running: false, ready: false, error: error.message };
                }
            }

            // Play success sound when ComfyUI is ready
            function playSuccessSound() {
                try {
                    // Only play if tab is active
                    if (document.hidden) return;

                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    // Two-tone notification sound
                    oscillator.frequency.value = 523.25; // C5 note
                    oscillator.type = 'sine';

                    // Fade in and out
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);

                    // Play second tone
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);

                        osc2.frequency.value = 659.25; // E5 note
                        osc2.type = 'sine';

                        gain2.gain.setValueAtTime(0, audioContext.currentTime);
                        gain2.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                        gain2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.15);

                        osc2.start(audioContext.currentTime);
                        osc2.stop(audioContext.currentTime + 0.15);
                    }, 100);
                } catch (error) {
                    // Silently fail if audio not supported
                    console.log('Audio not available:', error);
                }
            }

            async function startComfyUI() {
                const username = document.getElementById('username').value;
                if (!username || username === '') {
                    showToast('Please select a user from the dropdown', 'error');
                    return;
                }

                const primaryBtn = document.getElementById('primaryBtn');

                //  SPECIAL LAUNCH ANIMATION!
                // 1. Button explosion effect
                gsap.to(primaryBtn, {
                    scale: 1.2,
                    duration: 0.15,
                    ease: 'power2.out',
                    onComplete: () => {
                        gsap.to(primaryBtn, { scale: 1, duration: 0.3, ease: 'elastic.out(1, 0.5)' });
                    }
                });

                // 2. Create energy burst particles
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    const angle = (Math.PI * 2 * i) / 12;
                    particle.style.cssText = `
                        position: absolute;
                        width: 8px;
                        height: 8px;
                        background: var(--primary);
                        border-radius: 50%;
                        left: 50%;
                        top: 50%;
                        pointer-events: none;
                        box-shadow: 0 0 10px var(--primary);
                    `;
                    primaryBtn.appendChild(particle);

                    gsap.to(particle, {
                        x: Math.cos(angle) * 80,
                        y: Math.sin(angle) * 80,
                        opacity: 0,
                        scale: 0,
                        duration: 0.8,
                        ease: 'power2.out',
                        onComplete: () => particle.remove()
                    });
                }

                // 3. Screen flash effect
                const flash = document.createElement('div');
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: radial-gradient(circle, rgba(107, 107, 107, 0.3), transparent);
                    pointer-events: none;
                    z-index: 9999;
                `;
                document.body.appendChild(flash);
                gsap.to(flash, {
                    opacity: 0,
                    duration: 0.5,
                    ease: 'power2.out',
                    onComplete: () => flash.remove()
                });

                // 4. Container shake effect - REMOVED per user request

                primaryBtn.disabled = true;
                primaryBtn.classList.add('btn-loading');
                primaryBtn.textContent = 'Starting...';

                // Update status indicator and start timer
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                statusDot.className = 'status-dot starting';
                statusText.textContent = 'Starting ComfyUI...';

                // Start initialization timer
                initializationStartTime = Date.now();

                // Start counter update interval (every 1 second for smooth updates)
                counterInterval = setInterval(() => {
                    if (initializationStartTime) {
                        const elapsed = Math.floor((Date.now() - initializationStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                        const statusText = document.getElementById('statusText');
                        const statusDot = document.getElementById('statusDot');
                        if (statusText && statusDot) {
                            statusDot.className = 'status-dot initializing';
                            statusText.textContent = `Initializing  ${timeStr} elapsed`;
                        }
                    }
                }, 1000);

                // Optionally show loading overlay (make it less intrusive)
                // showLoading(true, 'Starting ComfyUI...', 'Initializing workspace');
                checkAttempts = 0;

                // Track when we started ComfyUI BEFORE the fetch to prevent premature "Offline" status
                // This ensures the periodic status check sees lastStartTime immediately
                lastStartTime = Date.now();

                try {
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username})
                    });

                    // Check if response is valid BEFORE trying to parse JSON
                    // This catches HTTP errors (524, 500, etc.) before JSON parsing
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        // lastStartTime already set above before fetch

                        showToast('ComfyUI process started! Waiting for full initialization...', 'success');

                        // Change button text but keep disabled
                        primaryBtn.textContent = 'Initializing...';

                        // Start real-time progress monitoring with error handling
                        let eventSource = null;
                        let eventSourceClosed = false;
                        let useEventSource = true;

                        // Function to start EventSource with proper error handling
                        function startEventSource() {
                            // Skip EventSource entirely if it's not supported or unreliable
                            if (!window.EventSource || !useEventSource) {
                                console.log('EventSource not available, using polling only');
                                return;
                            }

                            try {
                                eventSource = new EventSource('/api/startup-stream');
                                let connectionTimeout = setTimeout(() => {
                                    // If no message in 5 seconds, assume EventSource is broken
                                    if (eventSource && !eventSourceClosed) {
                                        console.log('EventSource timeout - falling back to polling');
                                        eventSource.close();
                                        eventSourceClosed = true;
                                        useEventSource = false;
                                    }
                                }, 5000);

                                eventSource.onopen = () => {
                                    console.log('EventSource connected');
                                    clearTimeout(connectionTimeout);
                                };

                                eventSource.onmessage = (event) => {
                                    clearTimeout(connectionTimeout);
                                    // Reset timeout for next message
                                    connectionTimeout = setTimeout(() => {
                                        if (eventSource && !eventSourceClosed) {
                                            console.log('EventSource message timeout');
                                            eventSource.close();
                                            eventSourceClosed = true;
                                            useEventSource = false;
                                        }
                                    }, 10000);

                                    let progress;

                                    // Check if we got HTML instead of JSON (error page)
                                    if (event.data.startsWith('<!DOCTYPE') || event.data.startsWith('<html') || event.data.includes('</html>')) {
                                        console.error('Received HTML instead of JSON - server error');
                                        clearTimeout(connectionTimeout);
                                        eventSource.close();
                                        eventSourceClosed = true;
                                        useEventSource = false;
                                        return;
                                    }

                                    try {
                                        progress = JSON.parse(event.data);
                                    } catch (e) {
                                        // Silently handle JSON parse errors (common during startup)
                                        // If we get invalid JSON, disable EventSource
                                        if (event.data && event.data.length > 0) {
                                            clearTimeout(connectionTimeout);
                                            eventSource.close();
                                            eventSourceClosed = true;
                                            useEventSource = false;
                                        }
                                        return;
                                    }

                            // Update status indicator instead of loading overlay
                            const statusDot = document.getElementById('statusDot');
                            const statusText = document.getElementById('statusText');

                            // Update loading overlay if it's visible
                            if (document.getElementById('loadingOverlay').classList.contains('active')) {
                                document.getElementById('loadingText').textContent = progress.message || 'Starting ComfyUI...';
                                document.getElementById('loadingProgress').textContent = `${progress.percent}%`;
                            }

                            // Update status based on stage
                            if (progress.stage === 'importing' || progress.stage === 'loading_nodes') {
                                statusDot.className = 'status-dot initializing';
                                statusText.textContent = `Initializing  ${progress.message || 'Loading nodes...'}`;
                                primaryBtn.textContent = progress.message || 'Loading custom nodes...';
                                if (document.getElementById('loadingSubtext')) {
                                    document.getElementById('loadingSubtext').textContent = 'Loading custom nodes...';
                                }
                            } else if (progress.stage === 'starting_server') {
                                statusDot.className = 'status-dot initializing';
                                statusText.textContent = 'Initializing  Starting server...';
                                primaryBtn.textContent = 'Starting server...';
                                if (document.getElementById('loadingSubtext')) {
                                    document.getElementById('loadingSubtext').textContent = 'Starting web server...';
                                }
                            } else if (progress.stage === 'ready') {
                                eventSource.close();
                                eventSourceClosed = true;
                                // Status will be updated by the checkInterval logic
                            } else if (progress.stage === 'failed') {
                                eventSource.close();
                                eventSourceClosed = true;
                                clearInterval(checkInterval);

                                // Update status to show error
                                statusDot.className = 'status-dot error';
                                statusText.textContent = `Error  ${progress.message || 'Failed to start'}`;

                                // Hide loading overlay if shown
                                showLoading(false);
                                showToast(progress.message || 'ComfyUI failed to start', 'error');
                                primaryBtn.classList.remove('btn-loading');
                                primaryBtn.textContent = 'Launch ComfyUI';
                                primaryBtn.disabled = false;
                            } else if (progress.stage === 'initializing') {
                                statusDot.className = 'status-dot starting';
                                statusText.textContent = `Starting  ${progress.message || 'Initializing...'}`;
                                primaryBtn.textContent = progress.message || 'Initializing...';
                            } else {
                                // Generic progress update
                                statusDot.className = 'status-dot initializing';
                                const percentText = progress.percent > 0 ? ` (${progress.percent}%)` : '';
                                statusText.textContent = `Initializing  ${progress.message || 'Loading...'}${percentText}`;
                                primaryBtn.textContent = progress.message || `Loading... ${percentText}`;
                            }
                        };

                                eventSource.onerror = (error) => {
                                    clearTimeout(connectionTimeout);
                                    if (!eventSourceClosed) {
                                        console.error('EventSource error - disabling and using polling');
                                        eventSource.close();
                                        eventSourceClosed = true;
                                        useEventSource = false;

                                        // Keep status visible and show we're still checking
                                        const statusDot = document.getElementById('statusDot');
                                        const statusText = document.getElementById('statusText');
                                        if (statusDot && statusText) {
                                            statusDot.className = 'status-dot initializing';
                                            statusText.textContent = 'Initializing  Starting ComfyUI...';
                                        }
                                    }
                                };
                            } catch (error) {
                                console.error('Failed to create EventSource:', error);
                                useEventSource = false;
                            }
                        }

                        // Start with polling as primary method (reliable)
                        // EventSource will be tried after initial connection is stable
                        let pollingStarted = true;

                        // Disable EventSource initially to avoid HTML errors
                        useEventSource = false;

                        // Start polling immediately (every 2 seconds during startup)
                        checkInterval = setInterval(async () => {
                            checkAttempts++;

                            // Only try EventSource after 20 seconds and if backend is responding
                            if (checkAttempts === 10 && !eventSource && !eventSourceClosed) {
                                // First check if the backend is ready
                                try {
                                    const testResponse = await fetch('/api/status');
                                    if (testResponse.ok) {
                                        console.log('Backend ready, attempting EventSource connection');
                                        useEventSource = true;
                                        startEventSource();
                                    }
                                } catch (e) {
                                    console.log('Backend not ready yet, skipping EventSource');
                                }
                            }

                            // Keep status indicator visible during checks
                            const statusDot = document.getElementById('statusDot');
                            const statusText = document.getElementById('statusText');

                            // Don't hide status while checking
                            if (!statusDot || !statusText) {
                                console.error('Status elements not found');
                                return;
                            }

                            // Update status to show progress if still initializing
                            if (checkAttempts > 0 && checkAttempts % 5 === 0 && statusDot.className.includes('initializing')) {
                                const elapsed = Math.floor(checkAttempts * 2); // 2 seconds per check
                                if (!eventSource || eventSourceClosed) {
                                    statusText.textContent = `Initializing  Loading ComfyUI (${elapsed}s)...`;
                                }
                            }

                            try {
                                const statusResponse = await fetch('/api/status');
                                const statusData = await statusResponse.json();

                                if (statusData.running && statusData.ready) {
                                    clearInterval(checkInterval);
                                    checkInterval = null;

                                    // Close EventSource if still open
                                    if (eventSource && !eventSourceClosed) {
                                        eventSource.close();
                                        eventSourceClosed = true;
                                    }

                                    // Clear initialization timer and counter
                                    initializationStartTime = null;
                                    if (counterInterval) {
                                        clearInterval(counterInterval);
                                        counterInterval = null;
                                    }

                                    // Hide loading overlay if it's shown
                                    if (document.getElementById('loadingOverlay') && document.getElementById('loadingOverlay').classList.contains('active')) {
                                        showLoading(false);
                                    }

                                    // Use consolidated function to update UI
                                    updateUIForRunningState(username);

                                    showToast('ComfyUI is ready! Click "Open ComfyUI" to access it.', 'success');

                                    // Show success Lottie animation
                                    if (typeof showLottieSuccess === 'function') {
                                        showLottieSuccess();
                                    }

                                    // Update start time for uptime tracking
                                    if (statusData.start_time) {
                                        startTime = statusData.start_time * 1000;
                                        updateUptime();
                                    }
                                }
                                // No fixed timeout - ComfyUI will start when it's ready!
                            } catch (error) {
                                console.error('Status check error:', error);
                            }
                        }, 1500);
                    } else {
                        // Update status to show error
                        const statusDot = document.getElementById('statusDot');
                        const statusText = document.getElementById('statusText');
                        statusDot.className = 'status-dot error';
                        statusText.textContent = `Error  ${data.error || 'Failed to start'}`;

                        showLoading(false);
                        showToast(data.error || 'Failed to start ComfyUI', 'error');
                        primaryBtn.classList.remove('btn-loading');
                        primaryBtn.textContent = 'Launch ComfyUI';
                        primaryBtn.disabled = false;
                    }
                } catch (error) {
                    // Don't silently ignore errors from the start request - show them to user
                    // (Silent handling is only for background status checks, not the initial start command)
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');
                    statusDot.className = 'status-dot error';
                    statusText.textContent = `Error  ${error.message}`;

                    showLoading(false);
                    showToast('Error: ' + error.message, 'error');
                    const primaryBtn = document.getElementById('primaryBtn');
                    if (primaryBtn) {
                        primaryBtn.classList.remove('btn-loading');
                        primaryBtn.textContent = 'Launch ComfyUI';
                        primaryBtn.disabled = false;
                    }
                }
            }

            async function stopComfyUI() {
                if (!confirm('Stop ComfyUI? All unsaved work will be lost.')) return;

                const stopBtn = document.getElementById('stopBtn');
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.textContent = 'Stopping...';
                }

                // Update status indicator
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                statusDot.className = 'status-dot starting';
                statusText.textContent = 'Stopping ComfyUI...';

                // Optionally show loading overlay
                // showLoading(true, 'Stopping ComfyUI...');

                try {
                    const response = await fetch('/api/stop', {
                        method: 'POST'
                    });

                    const data = await response.json();

                    // Wait a bit to ensure process is fully stopped
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    showLoading(false);
                    showToast('ComfyUI stopped successfully', 'success');

                    // Reset UI completely
                    setTimeout(() => {
                        location.reload();
                    }, 1000);

                } catch (error) {
                    showLoading(false);
                    showToast('Error stopping ComfyUI: ' + error.message, 'error');
                    if (stopBtn) {
                        stopBtn.disabled = false;
                        stopBtn.textContent = 'Stop';
                    }
                }
            }


            async function openComfyUI() {
                // Simply open ComfyUI directly without any retry mechanism
                const url = getRunPodUrl(8188);
                window.open(url, '_blank');
                showToast('Opening ComfyUI...', 'info');
            }

            function openJupyterLab() {
                const url = getRunPodUrl(8888);
                showToast('Opening JupyterLab...', 'info');
                window.open(url, '_blank');
            }

            async function restartService() {
                if (!confirm('Restart ComfyUI? This will stop and start the service.')) return;

                const restartBtn = document.getElementById('restartBtn');
                if (restartBtn) {
                    restartBtn.disabled = true;
                    restartBtn.textContent = 'Restarting...';
                }

                // Update status indicator
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                statusDot.className = 'status-dot starting';
                statusText.textContent = 'Restarting ComfyUI...';

                // Optionally show loading overlay
                // showLoading(true, 'Restarting ComfyUI...');

                try {
                    // Stop first
                    await fetch('/api/stop', { method: 'POST' });
                    await new Promise(resolve => setTimeout(resolve, 3000));  // Wait longer for full stop

                    const username = document.getElementById('username').value || {% if current_user %}'{{ current_user }}'{% else %}''{% endif %};
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username})
                    });

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to restart');
                    }

                    showLoading(false);
                    showToast('ComfyUI restarting. Page will reload...', 'success');
                    setTimeout(() => location.reload(), 2000);
                } catch (error) {
                    showLoading(false);
                    showToast('Error restarting: ' + error.message, 'error');
                    if (restartBtn) {
                        restartBtn.disabled = false;
                        restartBtn.textContent = 'Restart';
                    }
                }
            }

            // Update uptime display
            let startTime = {% if running and start_time %}{{ start_time * 1000 }}{% else %}null{% endif %};

            function updateUptime() {
                if (startTime) {
                    const elapsed = Date.now() - startTime;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const uptimeText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    document.getElementById('uptime').textContent = uptimeText;
                }
            }

            // Update uptime every minute
            setInterval(updateUptime, 60000);
            updateUptime(); // Initial update


            // Check status periodically
            setInterval(async () => {
                try {
                    const response = await fetch('/api/status');

                    // Validate response is JSON before parsing
                    const contentType = response.headers.get('content-type');
                    if (!response.ok || !contentType || !contentType.includes('application/json')) {
                        // Server returned HTML error page or other non-JSON response
                        // This happens during Flask restarts - don't show error, just skip this check
                        return;
                    }

                    const data = await response.json();

                    // Update UI if status changed
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');

                    if (data.running && data.ready) {
                        // ComfyUI is running and ready - update UI immediately
                        const username = data.current_user || 'User';

                        // Clear ALL initialization timers and tracking first
                        initializationStartTime = null;
                        lastStartTime = null;  // ComfyUI is ready, no longer need startup window
                        if (counterInterval) {
                            clearInterval(counterInterval);
                            counterInterval = null;
                        }

                        // Update UI
                        updateUIForRunningState(username);

                        // Update start time if we just started
                        if (data.start_time && !startTime) {
                            startTime = data.start_time * 1000;
                            updateUptime();
                        }
                    } else if (data.running && !data.ready) {
                        // Running but not ready yet - only update if not already initializing
                        // This prevents overwriting the detailed progress messages
                        if (!counterInterval && statusDot && statusText) {
                            // Start timer if not already started
                            if (!initializationStartTime) {
                                initializationStartTime = Date.now();
                            }

                            // Calculate elapsed time
                            const elapsed = Math.floor((Date.now() - initializationStartTime) / 1000);
                            const minutes = Math.floor(elapsed / 60);
                            const seconds = elapsed % 60;
                            const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                            statusDot.className = 'status-dot initializing';
                            statusText.textContent = `Initializing  ${timeStr} elapsed`;
                        }
                    } else {
                        // Not running - but check if we recently started ComfyUI
                        const STARTUP_WINDOW = 20 * 60 * 1000; // 20 minutes in milliseconds
                        const withinStartupWindow = lastStartTime && (Date.now() - lastStartTime < STARTUP_WINDOW);

                        if (withinStartupWindow) {
                            // We recently started ComfyUI - keep showing "Initializing" even if API says not running
                            // This prevents premature "Offline" during normal startup delays
                            if (statusDot && statusText) {
                                const elapsed = Math.floor((Date.now() - lastStartTime) / 1000);
                                const minutes = Math.floor(elapsed / 60);
                                const seconds = elapsed % 60;
                                const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                                statusDot.className = 'status-dot initializing';
                                statusText.textContent = `Initializing  ${timeStr} elapsed`;
                            }
                        } else {
                            // Not within startup window - actually inactive
                            if (statusDot && statusText) {
                                statusDot.className = 'status-dot inactive';
                                statusText.textContent = 'Offline';
                            }
                            // Clear tracking variables since we're actually inactive
                            lastStartTime = null;
                        }
                        startTime = null;
                        initializationStartTime = null;
                        if (counterInterval) {
                            clearInterval(counterInterval);
                            counterInterval = null;
                        }
                    }
                } catch (error) {
                    // Silently ignore JSON parse errors and unexpected token errors during startup/restart
                    const isJsonError = error.message && (
                        error.message.includes('JSON') ||
                        error.message.includes('Unexpected token') ||
                        error.message.includes('SyntaxError')
                    );

                    // Only log non-JSON errors
                    if (!isJsonError) {
                        console.error('Status check failed:', error);
                    }
                }
            }, 3000);

            // Store current user globally
            window.currentUser = {% if current_user %}'{{ current_user }}'{% else %}null{% endif %};

            function openModelManager() {
                window.open('/models', '_blank');
            }

            // ComfyViewer removed - use ComfyUI-Gallery custom node instead

            // Make functions globally accessible for onclick handlers
            window.startComfyUI = startComfyUI;
            window.stopComfyUI = stopComfyUI;
            window.openComfyUI = openComfyUI;
            window.openJupyterLab = openJupyterLab;
            window.restartService = restartService;
            window.openModelManager = openModelManager;

            /* ===== ADVANCED STUNNING ANIMATIONS ===== */

            // Magnetic hover effect for buttons (exclude Add User button)
            document.querySelectorAll('.btn, button').forEach(btn => {
                // Skip magnetic effect for Add User button
                if (btn.classList.contains('btn-add-user')) return;

                btn.addEventListener('mousemove', (e) => {
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left - rect.width / 2;
                    const y = e.clientY - rect.top - rect.height / 2;

                    btn.style.transform = `translate(${x * 0.1}px, ${y * 0.1}px) scale(1.05)`;
                });

                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translate(0, 0) scale(1)';
                });
            });

            // Smooth scroll animations for elements
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -100px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        setTimeout(() => {
                            entry.target.style.animation = 'smoothSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards';
                        }, index * 100);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.card-glass, .action-btn, .stat-card').forEach(el => {
                observer.observe(el);
            });

            // Enhanced ripple effect on click
            document.querySelectorAll('.btn, button').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');

                    this.appendChild(ripple);

                    setTimeout(() => ripple.remove(), 600);
                });
            });

            // Add GPU acceleration to all animated elements
            document.querySelectorAll('.card-glass, .btn, button, .status-dot').forEach(el => {
                el.style.transform = 'translateZ(0)';
                el.style.willChange = 'transform';
                el.style.backfaceVisibility = 'hidden';
            });
        </script>

        <!-- Smart Interactive Effects Script -->
        <script>
            window.addEventListener("load", function () {
                // Smart ripple effect - only on primary buttons
                function addSmartRippleEffect(button) {
                    button.addEventListener("click", function (e) {
                        // Only add ripple if button is not disabled
                        if (this.disabled) return;

                        const ripple = document.createElement("span");
                        const rect = this.getBoundingClientRect();
                        const size = Math.max(rect.width, rect.height);
                        const x = e.clientX - rect.left - size / 2;
                        const y = e.clientY - rect.top - size / 2;

                        ripple.style.width = ripple.style.height = size + "px";
                        ripple.style.left = x + "px";
                        ripple.style.top = y + "px";
                        ripple.classList.add("ripple");

                        this.appendChild(ripple);

                        setTimeout(() => {
                            ripple.remove();
                        }, 400);
                    });
                }

                // Add smart ripple only to primary buttons
                document
                    .querySelectorAll(".btn-primary")
                    .forEach(addSmartRippleEffect);

                // Smart magnetic effect - subtle and responsive
                document.querySelectorAll(".action-btn").forEach((btn) => {
                    let isHovering = false;

                    btn.addEventListener("mouseenter", () => {
                        isHovering = true;
                    });

                    btn.addEventListener("mouseleave", () => {
                        isHovering = false;
                        btn.style.transform = "translate(0, 0) scale(1)";
                    });

                    btn.addEventListener("mousemove", function (e) {
                        if (!isHovering) return;

                        const rect = this.getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width / 2;
                        const y = e.clientY - rect.top - rect.height / 2;

                        // Very subtle magnetic effect
                        this.style.transform = `translate(${x * 0.05}px, ${y * 0.05}px) scale(1.05)`;
                    });
                });

                // Smart stagger animation for cards - only on first load
                const cards = document.querySelectorAll(".card");
                if (cards.length > 0) {
                    cards.forEach((card, index) => {
                        card.style.opacity = "0";
                        card.style.transform = "translateY(20px)";

                        setTimeout(() => {
                            card.style.transition =
                                "opacity 0.3s ease, transform 0.3s ease";
                            card.style.opacity = "1";
                            card.style.transform = "translateY(0)";
                        }, index * 50);
                    });
                }

                // Smart status updates - animate only when status changes
                let lastStatus = null;
                const statusDot = document.querySelector(".status-dot");
                const statusText = document.querySelector(".status-text");

                function updateStatusAnimation(newStatus) {
                    if (lastStatus !== newStatus) {
                        if (statusDot) {
                            statusDot.classList.remove(
                                "inactive",
                                "initializing",
                                "ready",
                            );
                            statusDot.classList.add(newStatus);
                        }
                        lastStatus = newStatus;
                    }
                }

                // NO TYPING ANIMATION - STATIC TEXT ONLY

                // Smart performance optimization
                let ticking = false;
                function updateAnimations() {
                    // Batch DOM updates for better performance
                    ticking = false;
                }

                function requestTick() {
                    if (!ticking) {
                        requestAnimationFrame(updateAnimations);
                        ticking = true;
                    }
                }

                // Expose status update function globally
                window.updateStatusAnimation = updateStatusAnimation;
            });
        </script>

        <style>
            /* Ripple effect styles */
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.5);
                transform: scale(0);
                animation: rippleEffect 0.6s ease-out;
                pointer-events: none;
            }

            /* GPU-accelerated transitions */
            .btn,
            button,
            .card-glass {
                transition:
                    transform 0.2s cubic-bezier(0.16, 1, 0.3, 1),
                    box-shadow 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            }
        </style>

        <!-- Advanced Glassmorphism Background -->
        <script>
            // Simple background - no complex interactions
        </script>

        <!-- Three.js Advanced Particle System -->
        <script>
            // Particle system removed - keeping simple background
        </script>

        <!-- Typing Animation -->
        <script>
            // Typing animation that starts immediately when page loads
            document.addEventListener("DOMContentLoaded", function () {
                const title = document.getElementById("title-text");
                if (!title) return;

                const fullText = 'COMFY<span class="ui">UI</span>';
                let currentText = "";
                let index = 0;

                function typeNextChar() {
                    if (index < fullText.length) {
                        // Handle HTML tags properly
                        if (fullText[index] === "<") {
                            // Find the end of the HTML tag
                            const tagEnd = fullText.indexOf(">", index);
                            if (tagEnd !== -1) {
                                currentText += fullText.substring(
                                    index,
                                    tagEnd + 1,
                                );
                                index = tagEnd + 1;
                            } else {
                                currentText += fullText[index];
                                index++;
                            }
                        } else {
                            currentText += fullText[index];
                            index++;
                        }

                        title.innerHTML =
                            currentText +
                            '<span class="typing-cursor">|</span>';
                        setTimeout(typeNextChar, 100);
                    } else {
                        // Animation complete - keep cursor blinking
                        title.innerHTML =
                            currentText +
                            '<span class="typing-cursor">|</span>';
                    }
                }

                // Start typing animation immediately
                typeNextChar();
            });

            // Simple ripple effect
            function createRipple(event) {
                const button = event.currentTarget;
                const ripple = document.createElement("span");
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                pointer-events: none;
                z-index: 10;
                animation: ripple 0.6s ease-out forwards;
            `;

                button.appendChild(ripple);

                setTimeout(() => ripple.remove(), 600);
            }

            // Add ripple to all buttons
            document.querySelectorAll(".btn").forEach((btn) => {
                btn.addEventListener("click", createRipple);
            });

            // ===== Add User Modal Functions =====
            function showAddUserModal() {
                const modal = document.getElementById("addUserModal");
                if (modal) {
                    modal.style.display = "flex";
                    document.getElementById("newUsername").value = "";
                    document.getElementById("newUsername").focus();
                }
            }

            function closeAddUserModal() {
                const modal = document.getElementById("addUserModal");
                if (modal) {
                    modal.style.display = "none";
                }
            }

            async function addNewUser() {
                const username = document
                    .getElementById("newUsername")
                    .value.trim()
                    .toLowerCase();
                const submitBtn = document.querySelector(
                    "#addUserModal .btn-primary",
                );
                const originalText = submitBtn.textContent;

                // Validation
                if (!username) {
                    showToast("Please enter a username", "error");
                    return;
                }

                if (!/^[a-z0-9_]+$/.test(username)) {
                    showToast(
                        "Username must be lowercase alphanumeric and underscore only",
                        "error",
                    );
                    return;
                }

                // Disable button during request
                submitBtn.disabled = true;
                submitBtn.textContent = "Adding...";

                try {
                    const response = await fetch("/api/add_user", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            username: username,
                        }),
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(data.message, "success");
                        closeAddUserModal();

                        // Reload page to update user dropdown
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast(data.error || "Failed to add user", "error");
                    }
                } catch (error) {
                    showToast("Error: " + error.message, "error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }

            // Close modal on escape key
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape") {
                    closeAddUserModal();
                }
            });

            // Close modal when clicking outside
            window.addEventListener("click", function (event) {
                const modal = document.getElementById("addUserModal");
                if (event.target === modal) {
                    closeAddUserModal();
                }
            });
        </script>

        <!-- Add User Modal -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New User</h2>
                    <button class="modal-close" onclick="closeAddUserModal()">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newUsername">Username</label>
                        <input
                            type="text"
                            id="newUsername"
                            placeholder="e.g., john_doe"
                            autocomplete="off"
                            pattern="[a-z0-9_]+"
                            title="Lowercase letters, numbers, and underscores only"
                        />
                        <small class="form-hint"
                            >Lowercase letters, numbers, and underscores
                            only</small
                        >
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        class="btn btn-secondary"
                        onclick="closeAddUserModal()"
                    >
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="addNewUser()">
                        Add User
                    </button>
                </div>
            </div>
        </div>
    </body>
</html>
