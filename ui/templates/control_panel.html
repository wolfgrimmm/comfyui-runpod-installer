<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Cache-Control"
            content="no-cache, no-store, must-revalidate"
        />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <title>RunDeck</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&family=Space+Grotesk:wght@500;600;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://unpkg.com/lucide@latest"></script>

        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html,
            body {
                height: 100%;
                font-family: "Inter", sans-serif;
                background: #000;
                color: rgba(255, 255, 255, 0.9);
                overflow-x: hidden;
            }

            .app {
                width: 100%;
                max-width: 1440px;
                min-height: 100vh;
                margin: 0 auto;
                position: relative;
                background: #000;
            }

            /* Animated background like RunPod Pod Creator */
            .bg {
                position: fixed;
                inset: 0;
                background: #0a0a0a;
                z-index: 0;
                overflow: hidden;
            }

            .bg::before {
                content: "";
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background:
                    radial-gradient(
                        ellipse at 20% 20%,
                        rgba(139, 92, 246, 0.15) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        ellipse at 80% 80%,
                        rgba(236, 72, 153, 0.1) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        ellipse at 40% 60%,
                        rgba(59, 130, 246, 0.08) 0%,
                        transparent 40%
                    );
                animation: bgMove 20s ease-in-out infinite;
            }

            .bg::after {
                content: "";
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.4);
            }

            @keyframes bgMove {
                0%,
                100% {
                    transform: translate(0, 0) rotate(0deg);
                }
                25% {
                    transform: translate(2%, 2%) rotate(1deg);
                }
                50% {
                    transform: translate(0, 4%) rotate(0deg);
                }
                75% {
                    transform: translate(-2%, 2%) rotate(-1deg);
                }
            }

            /* Content wrapper */
            .content {
                position: relative;
                z-index: 1;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }

            /* ==================== HEADER ==================== */
            .header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 24px 40px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 24px;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .logo-dot {
                width: 10px;
                height: 10px;
                background: #8b5cf6;
                border-radius: 50%;
            }

            .logo-text {
                font-family: "Space Grotesk", sans-serif;
                font-size: 14px;
                font-weight: 600;
                letter-spacing: 2px;
                color: rgba(255, 255, 255, 0.9);
            }

            /* Status Pill */
            .status-pill {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 5px 10px;
                border-radius: 100px;
                font-size: 12px;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .status-pill.online {
                background: rgba(34, 197, 94, 0.125);
                color: #22c55e;
            }

            .status-pill.offline {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.6);
            }

            .status-pill.initializing {
                background: rgba(245, 158, 11, 0.125);
                color: #f59e0b;
            }

            .status-pill.error {
                background: rgba(239, 68, 68, 0.125);
                color: #ef4444;
            }

            .status-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .status-pill.online .status-dot {
                background: #22c55e;
                box-shadow: 0 0 8px #22c55e;
                animation: pulse 2s infinite;
            }

            .status-pill.offline .status-dot {
                background: rgba(255, 255, 255, 0.6);
            }

            .status-pill.initializing .status-dot {
                background: #f59e0b;
                box-shadow: 0 0 8px #f59e0b;
                animation: pulse 1s infinite;
            }

            .status-pill.error .status-dot {
                background: #ef4444;
                box-shadow: 0 0 8px #ef4444;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.7;
                    transform: scale(1.2);
                }
            }

            /* Header buttons */
            .header-right {
                display: flex;
                gap: 8px;
            }

            .icon-btn {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 10px;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .icon-btn:hover {
                background: rgba(255, 255, 255, 0.06);
                color: rgba(255, 255, 255, 0.9);
            }

            .icon-btn svg {
                width: 18px;
                height: 18px;
            }

            /* ==================== MAIN ==================== */
            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 24px;
                padding: 32px 40px;
            }

            .top-row {
                display: flex;
                gap: 24px;
                flex: 1;
            }

            @media (max-width: 1024px) {
                .top-row {
                    flex-direction: column;
                }
            }

            /* ==================== LEFT PANEL ==================== */
            .left-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 24px;
                padding: 24px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 20px;
            }

            /* Title section */
            .title-section {
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 16px;
            }

            .title-text h1 {
                font-family: "Space Grotesk", sans-serif;
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 6px;
            }

            .title-text p {
                font-size: 14px;
                color: rgba(255, 255, 255, 0.33);
            }

            /* User dropdown */
            .user-dropdown-wrapper {
                position: relative;
            }

            .user-dropdown {
                position: relative;
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 10px;
                cursor: pointer;
                min-width: 140px;
            }

            .user-dropdown:hover {
                background: rgba(255, 255, 255, 0.06);
            }

            .user-avatar {
                width: 24px;
                height: 24px;
                background: #8b5cf6;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: 600;
                color: white;
            }

            .user-avatar.offline {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.6);
            }

            .user-select {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.9);
                font-size: 13px;
                font-weight: 500;
                font-family: "Inter", sans-serif;
                cursor: pointer;
                outline: none;
                appearance: none;
                -webkit-appearance: none;
                padding-left: 44px;
                padding-right: 32px;
            }

            .user-select:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .user-select option {
                background: #1a1a1a;
                color: white;
            }

            .user-dropdown svg {
                width: 14px;
                height: 14px;
                color: rgba(255, 255, 255, 0.6);
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
            }

            /* Actions */
            .actions {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .primary-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                height: 56px;
                background: #8b5cf6;
                border: none;
                border-radius: 14px;
                font-family: "Space Grotesk", sans-serif;
                font-size: 16px;
                font-weight: 600;
                color: white;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .primary-btn:hover:not(:disabled) {
                background: #a78bfa;
                transform: translateY(-2px);
            }

            .primary-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .primary-btn.loading {
                background: rgba(139, 92, 246, 0.5);
                cursor: wait;
            }

            .primary-btn.success {
                background: #22c55e;
            }

            .primary-btn.success:hover:not(:disabled) {
                background: #16a34a;
            }

            .primary-btn svg {
                width: 20px;
                height: 20px;
            }

            .secondary-row {
                display: flex;
                gap: 12px;
            }

            .secondary-btn {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                height: 48px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 12px;
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .secondary-btn:hover:not(.disabled) {
                background: rgba(255, 255, 255, 0.06);
                color: rgba(255, 255, 255, 0.9);
            }

            .secondary-btn.disabled {
                opacity: 0.4;
                pointer-events: none;
            }

            .secondary-btn svg {
                width: 16px;
                height: 16px;
            }

            .secondary-btn.stop {
                background: rgba(239, 68, 68, 0.08);
                border-color: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

            .secondary-btn.stop:hover:not(.disabled) {
                background: rgba(239, 68, 68, 0.15);
            }

            /* Stats */
            .stats {
                display: flex;
                gap: 12px;
            }

            .stat-card {
                flex: 1;
                padding: 16px;
                background: rgba(255, 255, 255, 0.025);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 16px;
            }

            .stat-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }

            .stat-label {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.33);
            }

            .stat-header svg {
                width: 14px;
                height: 14px;
            }

            .stat-header svg.timer {
                color: #8b5cf6;
            }
            .stat-header svg.gpu {
                color: #22c55e;
            }
            .stat-header svg.inactive {
                color: rgba(255, 255, 255, 0.27);
            }

            .stat-value {
                font-family: "Space Grotesk", sans-serif;
                font-size: 24px;
                font-weight: 600;
            }

            .stat-value.inactive {
                color: rgba(255, 255, 255, 0.27);
            }

            /* GPU bar */
            .gpu-bar {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 12px;
                background: rgba(255, 255, 255, 0.015);
                border-radius: 8px;
            }

            .gpu-bar svg {
                width: 14px;
                height: 14px;
                color: rgba(255, 255, 255, 0.27);
            }

            .gpu-bar span {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.27);
            }

            /* ==================== RIGHT PANEL ==================== */
            .right-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 12px;
            }

            .links-row {
                display: flex;
                gap: 12px;
                flex: 1;
            }

            .link-card {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 10px;
                padding: 20px 16px;
                background: rgba(255, 255, 255, 0.025);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                cursor: pointer;
                text-decoration: none;
                transition: all 0.2s ease;
                min-height: 100px;
            }

            .link-card:hover {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
                transform: translateY(-2px);
            }

            .link-card svg {
                width: 18px;
                height: 18px;
            }
            .link-card span {
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.9);
            }

            .link-card.purple svg {
                color: #8b5cf6;
            }
            .link-card.green svg {
                color: #22c55e;
            }
            .link-card.amber svg {
                color: #f59e0b;
            }
            .link-card.cyan svg {
                color: #06b6d4;
            }

            /* ==================== CONSOLE ==================== */
            .console {
                height: 280px;
                display: flex;
                flex-direction: column;
                background: #0d0d0d;
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 16px;
                overflow: hidden;
            }

            .console-header {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.02);
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .console-header svg {
                width: 14px;
                height: 14px;
                color: rgba(255, 255, 255, 0.27);
            }

            .console-header span {
                font-size: 12px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.6);
            }

            .console-body {
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .log {
                font-family: "JetBrains Mono", monospace;
                font-size: 11px;
                line-height: 1.5;
                color: rgba(255, 255, 255, 0.4);
            }

            .log.success {
                color: #22c55e;
            }
            .log.info {
                color: #8b5cf6;
            }
            .log.error {
                color: #ef4444;
            }
            .log.warning {
                color: #f59e0b;
            }

            /* ==================== TOAST ==================== */
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                display: none;
                font-size: 14px;
                font-weight: 500;
                backdrop-filter: blur(10px);
                z-index: 1001;
                max-width: 320px;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .toast.success {
                background: rgba(34, 197, 94, 0.9);
                color: white;
            }

            .toast.error {
                background: rgba(239, 68, 68, 0.9);
                color: white;
            }

            .toast.info {
                background: rgba(139, 92, 246, 0.9);
                color: white;
            }

            /* ==================== MODAL ==================== */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10000;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: rgba(20, 20, 20, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 16px;
                width: 90%;
                max-width: 400px;
                animation: modalIn 0.3s ease;
            }

            @keyframes modalIn {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-header {
                padding: 20px 24px 16px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
            }

            .modal-close {
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.5);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                line-height: 1;
            }

            .modal-close:hover {
                color: rgba(255, 255, 255, 0.9);
            }

            .modal-body {
                padding: 20px 24px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.8);
            }

            .form-group input {
                width: 100%;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-family: "Inter", sans-serif;
            }

            .form-group input:focus {
                outline: none;
                border-color: #8b5cf6;
            }

            .form-hint {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.4);
                margin-top: 6px;
            }

            .modal-footer {
                padding: 16px 24px 20px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .modal-footer .btn {
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                border: none;
            }

            .modal-footer .btn-cancel {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(255, 255, 255, 0.7);
            }

            .modal-footer .btn-cancel:hover {
                background: rgba(255, 255, 255, 0.12);
            }

            .modal-footer .btn-submit {
                background: #8b5cf6;
                color: white;
            }

            .modal-footer .btn-submit:hover:not(:disabled) {
                background: #a78bfa;
            }

            .modal-footer .btn-submit:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .header {
                    padding: 16px 20px;
                }
                .main {
                    padding: 20px;
                }
                .links-row {
                    flex-direction: column;
                }
            }
        </style>
    </head>
    <body>
        <div class="app">
            <div class="bg"></div>

            <div class="content">
                <!-- Header -->
                <header class="header">
                    <div class="header-left">
                        <div class="logo">
                            <div class="logo-dot"></div>
                            <span class="logo-text">RUNDECK</span>
                        </div>
                        <div
                            class="status-pill {% if running %}online{% else %}offline{% endif %}"
                            id="statusPill"
                        >
                            <div class="status-dot"></div>
                            <span id="statusText"
                                >{% if running %}Running{% else %}Offline{%
                                endif %}</span
                            >
                        </div>
                    </div>
                    <div class="header-right">
                        <button
                            class="icon-btn"
                            onclick="showAddUserModal()"
                            title="Add User"
                        >
                            <i data-lucide="user-plus"></i>
                        </button>
                    </div>
                </header>

                <!-- Main -->
                <main class="main">
                    <div class="top-row">
                        <!-- Left Panel -->
                        <div class="left-panel">
                            <div class="title-section">
                                <div class="title-text">
                                    <h1 id="titleText">
                                        {% if running %}Running as {{
                                        current_user }}{% else %}ComfyUI
                                        Offline{% endif %}
                                    </h1>
                                    <p id="subtitleText">
                                        {% if running %}ComfyUI is ready to
                                        use{% else %}Select a user and launch
                                        ComfyUI{% endif %}
                                    </p>
                                </div>
                                <div class="user-dropdown-wrapper">
                                    <div class="user-dropdown">
                                        <div
                                            class="user-avatar {% if not current_user %}offline{% endif %}"
                                            id="userAvatar"
                                        >
                                            {% if current_user %}{{
                                            current_user[0]|upper }}{% else %}<i
                                                data-lucide="user"
                                                style="
                                                    width: 12px;
                                                    height: 12px;
                                                "
                                            ></i
                                            >{% endif %}
                                        </div>
                                        <select
                                            class="user-select"
                                            id="username"
                                            {%
                                            if
                                            running
                                            %}disabled{%
                                            endif
                                            %}
                                        >
                                            {% if not current_user %}
                                            <option value="" selected disabled>
                                                Select user
                                            </option>
                                            {% endif %} {% for user in users %}
                                            <option value="{{ user }}" {% if user == current_user %}selected{% endif %}>{{ user }}</option>
                                            {% endfor %}
                                        </select>
                                        <i data-lucide="chevron-down"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="actions" id="actionsContainer">
                                {% if running %}
                                <button
                                    class="primary-btn success"
                                    id="primaryBtn"
                                    onclick="openComfyUI()"
                                >
                                    <i data-lucide="external-link"></i>
                                    <span>Open ComfyUI</span>
                                </button>
                                <div class="secondary-row">
                                    <button
                                        class="secondary-btn"
                                        id="restartBtn"
                                        onclick="restartService()"
                                    >
                                        <i data-lucide="rotate-ccw"></i>
                                        <span>Restart</span>
                                    </button>
                                    <button
                                        class="secondary-btn stop"
                                        id="stopBtn"
                                        onclick="stopComfyUI()"
                                    >
                                        <i data-lucide="square"></i>
                                        <span>Stop</span>
                                    </button>
                                </div>
                                {% else %}
                                <button
                                    class="primary-btn"
                                    id="primaryBtn"
                                    onclick="startComfyUI()"
                                    {%
                                    if
                                    not
                                    current_user
                                    %}disabled{%
                                    endif
                                    %}
                                >
                                    <i data-lucide="play"></i>
                                    <span>Launch ComfyUI</span>
                                </button>
                                <div class="secondary-row">
                                    <button
                                        class="secondary-btn disabled"
                                        id="restartBtn"
                                    >
                                        <i data-lucide="rotate-ccw"></i>
                                        <span>Restart</span>
                                    </button>
                                    <button
                                        class="secondary-btn stop disabled"
                                        id="stopBtn"
                                    >
                                        <i data-lucide="square"></i>
                                        <span>Stop</span>
                                    </button>
                                </div>
                                {% endif %}
                            </div>

                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <span class="stat-label"
                                            >Session Time</span
                                        >
                                        <i
                                            data-lucide="timer"
                                            class="{% if running %}timer{% else %}inactive{% endif %}"
                                            id="timerIcon"
                                        ></i>
                                    </div>
                                    <div
                                        class="stat-value {% if not running %}inactive{% endif %}"
                                        id="sessionTime"
                                    >
                                        {% if running %}0m{% else %}--:--{%
                                        endif %}
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <i
                                            data-lucide="cpu"
                                            class="{% if running %}gpu{% else %}inactive{% endif %}"
                                            id="gpuIcon"
                                        ></i>
                                        <span class="stat-label">GPU</span>
                                    </div>
                                    <div
                                        class="stat-value {% if not running %}inactive{% endif %}"
                                        id="gpuUsage"
                                    >
                                        {% if running %}Active{% else %}--%{%
                                        endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="gpu-bar">
                                <i data-lucide="cpu"></i>
                                <span id="gpuInfo"
                                    >GPU information loading...</span
                                >
                            </div>
                        </div>

                        <!-- Right Panel -->
                        <div class="right-panel">
                            <div class="links-row">
                                <a
                                    class="link-card purple"
                                    href="https://pod-creator.skynetworkcdn.com/"
                                    target="_blank"
                                >
                                    <i data-lucide="plus"></i>
                                    <span>Pod Creator</span>
                                </a>
                                <a
                                    class="link-card green"
                                    href="https://s3-browser.skynetworkcdn.com/"
                                    target="_blank"
                                >
                                    <i data-lucide="folder"></i>
                                    <span>S3 Browser</span>
                                </a>
                            </div>
                            <div class="links-row">
                                <a
                                    class="link-card amber"
                                    href="javascript:void(0)"
                                    onclick="openJupyterLab()"
                                >
                                    <i data-lucide="notebook-text"></i>
                                    <span>JupyterLab</span>
                                </a>
                                <a
                                    class="link-card cyan"
                                    href="/models"
                                    target="_blank"
                                >
                                    <i data-lucide="boxes"></i>
                                    <span>Model Manager</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Console -->
                    <div class="console">
                        <div class="console-header">
                            <i data-lucide="terminal"></i>
                            <span>Console Output</span>
                        </div>
                        <div class="console-body" id="consoleBody">
                            <div class="log info">
                                [RunDeck] Control panel loaded
                            </div>
                            <div class="log">
                                {% if running %}[RunDeck] ComfyUI is running as
                                {{ current_user }}{% else %}[RunDeck] Waiting
                                for user to start ComfyUI...{% endif %}
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New User</h2>
                    <button class="modal-close" onclick="closeAddUserModal()">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newUsername">Username</label>
                        <input
                            type="text"
                            id="newUsername"
                            placeholder="e.g., john_doe"
                            autocomplete="off"
                        />
                        <div class="form-hint">
                            Lowercase letters, numbers, and underscores only
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        class="btn btn-cancel"
                        onclick="closeAddUserModal()"
                    >
                        Cancel
                    </button>
                    <button class="btn btn-submit" onclick="addNewUser()">
                        Add User
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Initialize Lucide icons
            lucide.createIcons();

            // State variables
            let checkInterval = null;
            let initializationStartTime = null;
            let counterInterval = null;
            let lastStartTime = null;
            let startTime = {% if running and start_time %}{{ start_time * 1000 }}{% else %}null{% endif %};
            let logEventSource = null;

            // Console logging
            function logToConsole(message, type = '') {
                const consoleBody = document.getElementById('consoleBody');
                const timestamp = new Date().toLocaleTimeString();
                const log = document.createElement('div');
                log.className = 'log ' + type;
                log.textContent = `[${timestamp}] ${message}`;
                consoleBody.appendChild(log);
                // Keep only last 200 logs in DOM
                while (consoleBody.children.length > 200) {
                    consoleBody.removeChild(consoleBody.firstChild);
                }
                consoleBody.scrollTop = consoleBody.scrollHeight;
            }

            // Determine log type from message content
            function getLogType(message) {
                const msg = message.toLowerCase();
                if (msg.includes('error') || msg.includes('failed') || msg.includes('exception')) return 'error';
                if (msg.includes('warning') || msg.includes('warn')) return 'warning';
                if (msg.includes('success') || msg.includes('ready') || msg.includes('loaded')) return 'success';
                if (msg.includes('import') || msg.includes('loading')) return 'info';
                return '';
            }

            // Start streaming ComfyUI logs
            function startLogStream() {
                if (logEventSource) {
                    logEventSource.close();
                }

                logEventSource = new EventSource('/api/logs/stream');

                logEventSource.onmessage = function(event) {
                    try {
                        const log = JSON.parse(event.data);
                        const type = getLogType(log.message);
                        const consoleBody = document.getElementById('consoleBody');
                        const logDiv = document.createElement('div');
                        logDiv.className = 'log ' + type;
                        logDiv.textContent = `[${log.time}] ${log.message}`;
                        consoleBody.appendChild(logDiv);
                        // Keep only last 200 logs in DOM
                        while (consoleBody.children.length > 200) {
                            consoleBody.removeChild(consoleBody.firstChild);
                        }
                        consoleBody.scrollTop = consoleBody.scrollHeight;
                    } catch (e) {
                        console.error('Error parsing log:', e);
                    }
                };

                logEventSource.onerror = function(e) {
                    console.log('Log stream disconnected, will retry...');
                    setTimeout(() => {
                        if (logEventSource) {
                            logEventSource.close();
                            startLogStream();
                        }
                    }, 3000);
                };
            }

            // Stop streaming logs
            function stopLogStream() {
                if (logEventSource) {
                    logEventSource.close();
                    logEventSource = null;
                }
            }

            // Toast notifications
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast ' + type;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 4000);
            }

            // URL helpers
            function getRunPodUrl(port) {
                const currentUrl = window.location.href;
                if (currentUrl.includes('proxy.runpod.net')) {
                    const matches = currentUrl.match(/https:\/\/([^-]+)-\d+\.proxy\.runpod\.net/);
                    if (matches) {
                        return `https://${matches[1]}-${port}.proxy.runpod.net/`;
                    }
                }
                return `http://${window.location.hostname}:${port}`;
            }

            // Update UI for running state
            function updateUIForRunningState(username) {
                const statusPill = document.getElementById('statusPill');
                const statusText = document.getElementById('statusText');
                const titleText = document.getElementById('titleText');
                const subtitleText = document.getElementById('subtitleText');
                const userAvatar = document.getElementById('userAvatar');
                const actionsContainer = document.getElementById('actionsContainer');
                const sessionTime = document.getElementById('sessionTime');
                const gpuUsage = document.getElementById('gpuUsage');
                const timerIcon = document.getElementById('timerIcon');
                const gpuIcon = document.getElementById('gpuIcon');
                const usernameSelect = document.getElementById('username');

                // Update status
                statusPill.className = 'status-pill online';
                statusText.textContent = 'Running';

                // Update title
                titleText.textContent = `Running as ${username}`;
                subtitleText.textContent = 'ComfyUI is ready to use';

                // Update avatar
                userAvatar.className = 'user-avatar';
                userAvatar.textContent = username[0].toUpperCase();

                // Disable user selection
                usernameSelect.disabled = true;

                // Update stats
                sessionTime.classList.remove('inactive');
                gpuUsage.classList.remove('inactive');
                gpuUsage.textContent = 'Active';
                timerIcon.classList.remove('inactive');
                timerIcon.classList.add('timer');
                gpuIcon.classList.remove('inactive');
                gpuIcon.classList.add('gpu');

                // Update actions
                actionsContainer.innerHTML = `
                    <button class="primary-btn success" id="primaryBtn" onclick="openComfyUI()">
                        <i data-lucide="external-link"></i>
                        <span>Open ComfyUI</span>
                    </button>
                    <div class="secondary-row">
                        <button class="secondary-btn" id="restartBtn" onclick="restartService()">
                            <i data-lucide="rotate-ccw"></i>
                            <span>Restart</span>
                        </button>
                        <button class="secondary-btn stop" id="stopBtn" onclick="stopComfyUI()">
                            <i data-lucide="square"></i>
                            <span>Stop</span>
                        </button>
                    </div>
                `;

                // Recreate icons
                lucide.createIcons();

                // Clear timers
                initializationStartTime = null;
                if (counterInterval) {
                    clearInterval(counterInterval);
                    counterInterval = null;
                }

                // Play success sound
                playSuccessSound();

                // Auto-open ComfyUI
                setTimeout(() => openComfyUI(), 500);
            }

            // Update UI for initializing state
            function updateUIForInitializingState(message) {
                const statusPill = document.getElementById('statusPill');
                const statusText = document.getElementById('statusText');
                const subtitleText = document.getElementById('subtitleText');

                statusPill.className = 'status-pill initializing';
                statusText.textContent = message || 'Initializing...';
                subtitleText.textContent = 'Please wait...';
            }

            // Play success sound
            function playSuccessSound() {
                try {
                    if (document.hidden) return;
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 523.25;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 659.25;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0, audioContext.currentTime);
                        gain2.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                        gain2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.15);
                        osc2.start(audioContext.currentTime);
                        osc2.stop(audioContext.currentTime + 0.15);
                    }, 100);
                } catch (e) {}
            }

            // Start ComfyUI
            async function startComfyUI() {
                const username = document.getElementById('username').value;
                if (!username) {
                    showToast('Please select a user', 'error');
                    return;
                }

                const primaryBtn = document.getElementById('primaryBtn');
                primaryBtn.disabled = true;
                primaryBtn.classList.add('loading');
                primaryBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i><span>Starting...</span>';
                lucide.createIcons();

                logToConsole(`Starting ComfyUI for user: ${username}`, 'info');

                lastStartTime = Date.now();
                initializationStartTime = Date.now();

                // Start counter interval
                counterInterval = setInterval(() => {
                    if (initializationStartTime) {
                        const elapsed = Math.floor((Date.now() - initializationStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                        updateUIForInitializingState(`Initializing (${timeStr})`);
                    }
                }, 1000);

                try {
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username})
                    });

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        logToConsole('ComfyUI process started, waiting for initialization...', 'success');
                        showToast('ComfyUI starting...', 'info');

                        // Start streaming ComfyUI logs
                        startLogStream();

                        // Start polling for ready state
                        checkInterval = setInterval(async () => {
                            try {
                                const statusResponse = await fetch('/api/status');
                                const statusData = await statusResponse.json();

                                if (statusData.running && statusData.ready) {
                                    clearInterval(checkInterval);
                                    checkInterval = null;
                                    logToConsole('ComfyUI is ready!', 'success');
                                    showToast('ComfyUI is ready!', 'success');
                                    updateUIForRunningState(username);

                                    if (statusData.start_time) {
                                        startTime = statusData.start_time * 1000;
                                        updateUptime();
                                    }
                                }
                            } catch (e) {
                                // Silently handle errors during startup
                            }
                        }, 1500);
                    } else {
                        throw new Error(data.error || 'Failed to start');
                    }
                } catch (error) {
                    logToConsole(`Error: ${error.message}`, 'error');
                    showToast(error.message, 'error');

                    if (counterInterval) {
                        clearInterval(counterInterval);
                        counterInterval = null;
                    }

                    primaryBtn.disabled = false;
                    primaryBtn.classList.remove('loading');
                    primaryBtn.innerHTML = '<i data-lucide="play"></i><span>Launch ComfyUI</span>';
                    lucide.createIcons();

                    const statusPill = document.getElementById('statusPill');
                    statusPill.className = 'status-pill error';
                    document.getElementById('statusText').textContent = 'Error';
                }
            }

            // Stop ComfyUI
            async function stopComfyUI() {
                if (!confirm('Stop ComfyUI? Unsaved work will be lost.')) return;

                const stopBtn = document.getElementById('stopBtn');
                stopBtn.classList.add('disabled');
                logToConsole('Stopping ComfyUI...', 'warning');

                try {
                    await fetch('/api/stop', { method: 'POST' });
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    showToast('ComfyUI stopped', 'success');
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    showToast('Error stopping: ' + error.message, 'error');
                    stopBtn.classList.remove('disabled');
                }
            }

            // Restart service
            async function restartService() {
                if (!confirm('Restart ComfyUI?')) return;

                logToConsole('Restarting ComfyUI...', 'warning');

                try {
                    await fetch('/api/stop', { method: 'POST' });
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    const username = document.getElementById('username').value || '{{ current_user }}';
                    await fetch('/api/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username})
                    });

                    showToast('Restarting...', 'info');
                    setTimeout(() => location.reload(), 2000);
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                }
            }

            // Open ComfyUI
            function openComfyUI() {
                const url = getRunPodUrl(8188);
                window.open(url, '_blank');
                logToConsole('Opening ComfyUI...', 'info');
            }

            // Open JupyterLab
            function openJupyterLab() {
                const url = getRunPodUrl(8888);
                window.open(url, '_blank');
                logToConsole('Opening JupyterLab...', 'info');
            }

            // Update uptime display
            function updateUptime() {
                if (startTime) {
                    const elapsed = Date.now() - startTime;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    document.getElementById('sessionTime').textContent = timeStr;
                }
            }

            // User dropdown change handler
            document.getElementById('username').addEventListener('change', function(e) {
                const primaryBtn = document.getElementById('primaryBtn');
                const userAvatar = document.getElementById('userAvatar');

                if (e.target.value) {
                    primaryBtn.disabled = false;
                    userAvatar.className = 'user-avatar';
                    userAvatar.textContent = e.target.value[0].toUpperCase();
                } else {
                    primaryBtn.disabled = true;
                }
                lucide.createIcons();
            });

            // Add user modal functions
            function showAddUserModal() {
                document.getElementById('addUserModal').style.display = 'flex';
                document.getElementById('newUsername').value = '';
                document.getElementById('newUsername').focus();
            }

            function closeAddUserModal() {
                document.getElementById('addUserModal').style.display = 'none';
            }

            async function addNewUser() {
                const username = document.getElementById('newUsername').value.trim().toLowerCase();
                const submitBtn = document.querySelector('#addUserModal .btn-submit');

                if (!username) {
                    showToast('Please enter a username', 'error');
                    return;
                }

                if (!/^[a-z0-9_]+$/.test(username)) {
                    showToast('Invalid username format', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding...';

                try {
                    const response = await fetch('/api/add_user', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: username })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('User added successfully', 'success');
                        closeAddUserModal();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(data.error || 'Failed to add user', 'error');
                    }
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add User';
                }
            }

            // Modal close handlers
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAddUserModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target.id === 'addUserModal') closeAddUserModal();
            });

            // Periodic status check
            setInterval(async () => {
                try {
                    const response = await fetch('/api/status');
                    const contentType = response.headers.get('content-type');
                    if (!response.ok || !contentType || !contentType.includes('application/json')) return;

                    const data = await response.json();
                    const statusPill = document.getElementById('statusPill');
                    const statusText = document.getElementById('statusText');

                    if (data.running && data.ready) {
                        const username = data.current_user || 'User';
                        statusPill.className = 'status-pill online';
                        statusText.textContent = 'Running';

                        if (data.start_time && !startTime) {
                            startTime = data.start_time * 1000;
                            updateUptime();
                        }
                    } else if (data.running && !data.ready) {
                        statusPill.className = 'status-pill initializing';
                        statusText.textContent = 'Initializing...';
                    } else {
                        const withinStartupWindow = lastStartTime && (Date.now() - lastStartTime < 20 * 60 * 1000);
                        if (withinStartupWindow) {
                            statusPill.className = 'status-pill initializing';
                            const elapsed = Math.floor((Date.now() - lastStartTime) / 1000);
                            const minutes = Math.floor(elapsed / 60);
                            const seconds = elapsed % 60;
                            statusText.textContent = `Initializing (${minutes > 0 ? minutes + 'm ' : ''}${seconds}s)`;
                        } else {
                            statusPill.className = 'status-pill offline';
                            statusText.textContent = 'Offline';
                        }
                    }
                } catch (e) {}
            }, 3000);

            // Update uptime every minute
            setInterval(updateUptime, 60000);
            updateUptime();

            // Load GPU info and start log stream if running
            fetch('/api/status').then(r => r.json()).then(data => {
                if (data.gpu_info) {
                    document.getElementById('gpuInfo').textContent = data.gpu_info;
                }
                // Start log stream if ComfyUI is running
                if (data.running) {
                    startLogStream();
                }
            }).catch(() => {});

            // Make functions global
            window.startComfyUI = startComfyUI;
            window.stopComfyUI = stopComfyUI;
            window.openComfyUI = openComfyUI;
            window.openJupyterLab = openJupyterLab;
            window.restartService = restartService;
            window.showAddUserModal = showAddUserModal;
            window.closeAddUserModal = closeAddUserModal;
            window.addNewUser = addNewUser;
        </script>
    </body>
</html>
