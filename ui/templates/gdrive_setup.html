<!-- Google Drive Setup Wizard -->
<div id="gdriveSetupWizard" class="setup-wizard" style="display: none;">
    <div class="wizard-backdrop"></div>
    <div class="wizard-content">
        <div class="wizard-header">
            <h2>Google Drive Setup</h2>
            <button class="close-btn" onclick="closeSetupWizard()">Ã—</button>
        </div>
        
        <div class="wizard-body">
            <!-- Step 1: Check Status -->
            <div class="setup-step" id="step-check" style="display: block;">
                <div class="step-icon">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                    </svg>
                </div>
                <h3>Checking Configuration</h3>
                <p>Verifying Google Drive setup status...</p>
                <div class="spinner"></div>
            </div>
            
            <!-- Step 2: Choose Setup Method -->
            <div class="setup-step" id="step-method" style="display: none;">
                <h3>Choose Setup Method</h3>
                <div class="setup-options">
                    <button class="setup-option" onclick="startOAuthSetup()">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                        <span class="option-title">Sign in with Google</span>
                        <span class="option-desc">Recommended - Use your Google account</span>
                    </button>
                    
                    <button class="setup-option" onclick="showManualSetup()">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                        <span class="option-title">Service Account</span>
                        <span class="option-desc">For enterprise/automated setup</span>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: OAuth Setup -->
            <div class="setup-step" id="step-oauth" style="display: none;">
                <h3>Sign in with Google</h3>
                <ol class="setup-instructions">
                    <li>Click the button below to open Google authorization</li>
                    <li>Sign in with your Google account</li>
                    <li>Grant access to Google Drive</li>
                    <li>Copy the authorization code</li>
                    <li>Paste it in the field below</li>
                </ol>
                
                <button class="btn btn-primary" id="authButton" onclick="openGoogleAuth()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                    </svg>
                    Open Google Authorization
                </button>
                
                <div class="auth-code-input" style="display: none;" id="authCodeInput">
                    <label>Authorization Code:</label>
                    <input type="text" id="authCode" placeholder="Paste your code here" class="input-field">
                    <button class="btn btn-primary" onclick="submitAuthCode()">Submit Code</button>
                </div>
            </div>
            
            <!-- Step 4: Service Account Setup -->
            <div class="setup-step" id="step-service" style="display: none;">
                <h3>Service Account Setup</h3>
                <p>Paste your service account JSON credentials:</p>
                <textarea id="serviceAccountJson" class="json-input" placeholder='{"type": "service_account", ...}'></textarea>
                <button class="btn btn-primary" onclick="submitServiceAccount()">Configure</button>
            </div>
            
            <!-- Step 5: Success -->
            <div class="setup-step" id="step-success" style="display: none;">
                <div class="step-icon success">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <h3>Setup Complete!</h3>
                <p>Google Drive has been configured successfully.</p>
                <p class="success-info">Your outputs will now automatically sync to:</p>
                <code class="path-display">ComfyUI-Output/outputs/[username]/</code>
                <button class="btn btn-primary" onclick="closeSetupWizard()">Done</button>
            </div>
            
            <!-- Error State -->
            <div class="setup-step" id="step-error" style="display: none;">
                <div class="step-icon error">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                </div>
                <h3>Setup Failed</h3>
                <p class="error-message" id="errorMessage">An error occurred during setup.</p>
                <button class="btn btn-secondary" onclick="retrySetup()">Try Again</button>
            </div>
        </div>
    </div>
</div>

<style>
.setup-wizard {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wizard-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
}

.wizard-content {
    position: relative;
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(30, 30, 30, 0.95));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.wizard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.wizard-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.close-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 2rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.wizard-body {
    padding: 32px;
}

.setup-step {
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.step-icon {
    margin: 0 auto 24px;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
    color: var(--primary);
}

.step-icon.success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.step-icon.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.setup-step h3 {
    margin-bottom: 16px;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.setup-step p {
    color: var(--text-secondary);
    margin-bottom: 24px;
}

.setup-options {
    display: grid;
    gap: 16px;
    margin-top: 24px;
}

.setup-option {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.setup-option:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--primary);
    transform: translateY(-2px);
}

.setup-option svg {
    color: var(--primary);
}

.option-title {
    display: block;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.option-desc {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.setup-instructions {
    text-align: left;
    margin: 24px 0;
    padding: 0 0 0 24px;
    color: var(--text-secondary);
}

.setup-instructions li {
    margin-bottom: 12px;
}

.auth-code-input {
    margin-top: 24px;
}

.auth-code-input label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.input-field {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 1rem;
    margin-bottom: 16px;
}

.input-field:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(255, 255, 255, 0.08);
}

.json-input {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.9rem;
    margin-bottom: 16px;
    resize: vertical;
}

.path-display {
    display: block;
    padding: 12px;
    background: rgba(231, 51, 29, 0.1);
    border: 1px solid rgba(231, 51, 29, 0.3);
    border-radius: 8px;
    color: var(--primary);
    font-family: 'Monaco', 'Menlo', monospace;
    margin: 16px 0;
}

.success-info {
    color: var(--text-secondary);
    margin-top: 16px;
}

.error-message {
    color: #ef4444;
    margin-bottom: 24px;
}
</style>

<script>
let authState = null;
let authUrl = null;

function showSetupWizard() {
    document.getElementById('gdriveSetupWizard').style.display = 'flex';
    checkGDriveSetup();
}

function closeSetupWizard() {
    document.getElementById('gdriveSetupWizard').style.display = 'none';
    // Refresh main status
    checkGDriveStatus();
}

function showStep(stepId) {
    // Hide all steps
    document.querySelectorAll('.setup-step').forEach(step => {
        step.style.display = 'none';
    });
    // Show selected step
    document.getElementById(stepId).style.display = 'block';
}

async function checkGDriveSetup() {
    showStep('step-check');
    
    try {
        const response = await fetch('/api/gdrive/oauth/check');
        const data = await response.json();
        
        if (data.configured) {
            // Already configured
            showStep('step-success');
        } else {
            // Need to configure
            showStep('step-method');
        }
    } catch (error) {
        showError('Failed to check configuration status');
    }
}

async function startOAuthSetup() {
    showStep('step-oauth');
    
    try {
        const response = await fetch('/api/gdrive/oauth/start');
        const data = await response.json();
        
        if (data.configured) {
            showStep('step-success');
        } else {
            authState = data.instructions.state;
            authUrl = data.instructions.auth_url;
            document.getElementById('authButton').disabled = false;
        }
    } catch (error) {
        showError('Failed to start OAuth setup');
    }
}

function openGoogleAuth() {
    if (authUrl) {
        // Open in new window
        const authWindow = window.open(authUrl, 'GoogleAuth', 'width=600,height=700');
        
        // Show code input field
        document.getElementById('authCodeInput').style.display = 'block';
        document.getElementById('authButton').disabled = true;
        document.getElementById('authButton').textContent = 'Waiting for authorization...';
    }
}

async function submitAuthCode() {
    const code = document.getElementById('authCode').value.trim();
    
    if (!code) {
        alert('Please enter the authorization code');
        return;
    }
    
    try {
        const response = await fetch('/api/gdrive/oauth/callback', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                code: code,
                state: authState
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStep('step-success');
        } else {
            showError(data.error || 'Failed to configure Google Drive');
        }
    } catch (error) {
        showError('Failed to submit authorization code');
    }
}

function showManualSetup() {
    showStep('step-service');
}

async function submitServiceAccount() {
    const jsonData = document.getElementById('serviceAccountJson').value.trim();
    
    if (!jsonData) {
        alert('Please paste the service account JSON');
        return;
    }
    
    try {
        // Validate JSON
        JSON.parse(jsonData);
        
        const response = await fetch('/api/gdrive/oauth/setup_service_account', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                service_account: jsonData
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStep('step-success');
        } else {
            showError(data.error || 'Failed to configure service account');
        }
    } catch (error) {
        if (error instanceof SyntaxError) {
            showError('Invalid JSON format');
        } else {
            showError('Failed to configure service account');
        }
    }
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    showStep('step-error');
}

function retrySetup() {
    showStep('step-method');
}

// Update the existing button to show wizard
function showConfigureDialog() {
    showSetupWizard();
}
</script>